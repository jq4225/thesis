---
title: "3_lockdowndates"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(janitor)
library(readxl)
library(lubridate)
```

```{r}
interventions_dirty <- 
read_excel('data/policy/Copy-of-Copy-of-Local-Policy-Responses-to-COVID-19.fin_ (1).xlsx',
           sheet = 'Local Policies') %>%
  # Get rid of city-specific policies
  filter(is.na(cityname)) %>%
  select(stfips, countyfips, stsipstart, stsipend, localsipstart, localsipend,
         dummysipstart, dummysipend, stbusclose, localbusclose, stbusopen, 
         localbusopen, dummybusclose, dummybusopen) %>%
  # Pick the earliest starts and the latest ends
  mutate(sipstart = ifelse(dummysipstart == 1, as_date(localsipstart), as_date(stsipstart)),
         sipend = ifelse(dummysipend == 1, as_date(localsipend), as_date(stsipend)),
         busclose = ifelse(dummybusclose == 1, as_date(localbusclose), as_date(stbusclose)),
         busopen = ifelse(dummybusopen == 1, as_date(localbusopen), as_date(stbusopen))) %>%
  select(stfips, countyfips, sipstart, sipend, busclose, busopen) %>%
  mutate(stfips = str_pad(stfips, width = 2, side = "left", pad = "0"),
         countyfips = str_pad(countyfips, width = 3, side = "left", pad = "0")) %>%
  mutate(fips = str_c(stfips, countyfips, sep = "")) %>%
  select(-stfips, -countyfips) %>%
  mutate(sipstart = as_date(sipstart),
         sipend = as_date(sipend),
         busclose = as_date(busclose),
         busopen = as_date(busopen)) %>%
  # Replace NAs with 2021 dates that never trigger to stop NA errors
  mutate(sipstart = replace_na(sipstart, as_date("2021-01-01")),
         sipend = replace_na(sipend, as_date("2021-01-01")),
         busclose = replace_na(busclose, as_date("2021-01-01")),
         busopen = replace_na(busopen, as_date("2021-01-01")))
```


```{r}
# Let's try to aggregate this by DMA and (maybe) week -- read in 
# goolsbee interventions

dma_codes <- read_csv('dma_codes.csv') %>%
  select(google_code, statefp, cntyfp) %>%
  mutate(statefp = str_pad(statefp, width = 2, side = "left", pad = "0"),
         cntyfp = str_pad(cntyfp, width = 3, side = "left", pad = 0)) %>%
  mutate(fips = str_c(statefp, cntyfp, sep = "")) %>%
  select(google_code, fips)

goolsbee_interventions <- readRDS('clean_data/goolsbee_interventions.rds') %>%
  mutate(across(c(`sipstart`:`busopen`), ~ ifelse(. == as_date("2021-01-01"),
                                                   as_date("2030-01-01"), .))) %>%
  mutate(across(c(`sipstart`:`busopen`), as_date))

# Unfinished

# Let's make a tibble of every FIPS-date combination

week_begin <- readRDS('week_begin.rds')

fips <- tibble(goolsbee_interventions$fips)

merged <- merge(week_begin, fips) %>%
  clean_names() %>%
  left_join(., goolsbee_interventions, by = c("goolsbee_interventions_fips" = "fips"))

# This gives us a dataframe of all county implementation dates

merged2 <- merged %>%
  as_tibble() %>%
  mutate(date = as_date(date)) %>%
  mutate(sip = ifelse(sipstart <= (date + days(6)) & sipend >= date + days(6),
                      1, 0),
         busclose = ifelse(busclose <= (date + days(6)) & busopen >= date + days(6),
                           1, 0)) %>%
  select(date, goolsbee_interventions_fips, sip, busclose)

# Now let's group this by DMA too -- read in the DMA codes here

merged3 <- left_join(merged2, dma_codes, by = c("goolsbee_interventions_fips" = "fips")) %>%
  drop_na(google_code) %>%
  group_by(date, google_code) %>%
  summarize(dmas = n(),
            sip_sum = sum(sip),
            busclose_sum = sum(busclose)) %>%
  mutate(sip_prop = sip_sum / dmas,
         busclose_prop = busclose_sum / dmas,
         sip_first = ifelse(sip_sum > 0, 1, 0),
         busclose_first = ifelse(busclose_sum > 0, 1, 0)) %>%
  mutate(sip_most = ifelse(sip_prop >= 0.5, 1, 0),
         busclose_most = ifelse(busclose_prop >= 0.5, 1, 0)) %>%
  select(date, google_code, sip_prop, busclose_prop,
         sip_first, busclose_first, sip_most, busclose_most)
```


```{r}
# State policy spreadsheets -- you need to add a state column to other things first
```

