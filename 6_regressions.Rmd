---
title: "5_regressions"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lfe)
library(texreg)
library(fixest)
```

```{r}
searches_v7 <- readRDS('clean_data/search/searches_v9.rds')

# Let's fuck around a bit and se what happens

searches_postlockdown <- searches_norm3 %>%
  filter(week >= 15)
```

```{r}
# Percentage of zeroes

zero_percent <- searches_norm3_v8 %>%
  group_by(dma) %>%
  select(dma, `alcohol`:`worry`, depression, cannabis:streaming_media) %>% 
  summarize(across(.cols = c(`alcohol`:`streaming_media`), ~ sum(.==0)),
            weeks = n()) %>%
  mutate(across(.cols = c(alcohol:streaming_media), ~ . * 100 / weeks)) %>%
  group_by(dma) %>%
  mutate(mean = mean(alcohol:streaming_media))

# Read in dma covid and merge

dma_pop_zero_percent <- left_join(dma_pop, zero_percent, by = c("google_code" = "dma")) %>%
  drop_na()

dma_5 <- dma_pop_zero_percent %>% 
  filter(mean <= 5) %>% 
  select(google_code) %>%
  distinct()

dma_5 <- c(dma_5$google_code)

missing_graph <- dma_pop_zero_percent %>% 
  ggplot(mapping = aes(x = total_pop, y = mean)) + 
    geom_point() + 
    scale_x_continuous(trans='log10') + 
    labs(x = "DMA Population (log scale)", y = "Mean Percent Zeroes") + 
    theme_classic()

zero_percent_summary <- zero_percent %>%
  ungroup() %>%
  summarize(across(.cols = alcohol:mental_health, ~ mean(., na.rm = TRUE))) %>%
  pivot_longer(cols = alcohol:mental_health, names_to = "term", values_to = "percent_zero")

# testing anchor index too 

zero_percent_anchor <- anchor_index %>%
  group_by(dma) %>%
  select(dma, `honey`:`japan`) %>% 
  summarize(across(.cols = c(`honey`:`japan`), ~ sum(.==0)),
            weeks = n()) %>%
  mutate(across(.cols = c(`honey`:`japan`), ~ . * 100 / weeks))

zero_summary_anchor <- zero_percent_anchor %>%
  summarize(across(.cols = `honey`:`japan`, mean)) %>%
  pivot_longer(cols = `honey`:`japan`, names_to = "term", values_to= "zero_percent")

# Maybe I should revise the anchor index adjusted terms

```

```{r}
# Run only regressions with less than 15 percent zeroes on average?

searches_norm3_v8_5 <- searches_norm3_v8 %>%
  filter(dma %in% dma_5)
```

```{r}
# read in searches v4 or later

test <- felm(I(log(depression + 1)) ~  sip_first * year_indicator + 
               deaths_per_100k + cases_per_100k +  
               unemploy_rate + economic_support_index|factor(dma):factor(year) + week|0|dma, 
             data = searches_v9)

test3 <-  felm(I(log(depression + 1)) ~  
                 sip_first * year_indicator + no_sip_first * year_indicator +
               cases_per_100k +
                 unemploy_rate + factor(debt_contract_relief) + factor(income_support) + 
                 precip + temp + covid + lockdown|
                 factor(dma):factor(year) + factor(week)|0|dma, 
             data = searches_norm3_v9)

test3 <-  felm(I(suicide) ~  sip_first * year_indicator + 
               deaths_per_100k + cases_per_100k +  
               unemploy_rate + economic_support_index|factor(dma):factor(year) + week|0|dma, 
             data = searches_norm3)
```
```{r}
# With re-scaling, depression

depression_sip <-  felm(I(log(depression + 1)) ~  
                 sip_first * year_indicator + no_sip_first * year_indicator +
               cases_per_100k +
                 unemploy_rate + factor(debt_contract_relief) + factor(income_support) + 
                 precip + temp + covid + lockdown|
                 factor(dma):factor(year) + factor(week)|0|dma, 
             data = searches_norm3_v9)

depression_busclose <- felm(I(log(depression + 1)) ~  
                 busclose_first * year_indicator + busopen_first * year_indicator +
               cases_per_100k +
                 unemploy_rate + factor(debt_contract_relief) + factor(income_support) + 
                 precip + temp + covid + lockdown|
                 factor(dma):factor(year) + factor(week)|0|dma, 
             data = searches_norm3_v9)
```


