---
title: "13_eventstudy"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lfe)
library(broom)
library(tidyverse)
```

```{r}
# What if I remake counters 

hps_all_v20_c1 <- hps_all_v20 %>% 
  drop_na(pop, c1_counter)

hps_all_v20_c2 <- hps_all_v20 %>% 
  drop_na(pop, c2_counter)
```

```{r}
# Remake the counters

hps_all_v20 <- hps_all_v19 %>% 
  mutate(c1_treat = ifelse(is.na(c1_counter), 0, 1),
         c2_treat = ifelse(is.na(c2_counter), 0, 1),
         c6_treat = ifelse(is.na(c6_counter), 0, 1)) %>% 
  mutate(across(c(c1_counter, c2_counter, c6_counter),
                ~ ifelse(is.na(.), 0, .))) %>% 
  mutate(across(c(c1_post_2, c1_post_1, c1_post_n1,
                  c2_post_2, c2_post_1, c2_post_n1,
                  c6_post_2, c6_post_1, c6_post_n1),
                ~ ifelse(is.na(.), 0, .)))

searches_norm3_v25_5 <- searches_norm3_v24_5 %>% 
  mutate(sip_treat = ifelse(is.na(sip_first_counter), 0, 1),
         busclose_treat = ifelse(is.na(busclose_first_counter), 0, 1),
         no_sip_treat = ifelse(is.na(no_sip_most_pop_counter), 0, 1),
         busopen_treat = ifelse(is.na(busopen_most_pop_counter), 0, 1)) %>% 
  mutate(across(c(sip_first_counter, busclose_first_counter, no_sip_most_pop_counter,
                  busopen_most_pop_counter), ~ as.numeric(as.character(.)))) %>% 
  mutate(across(c(sip_first_counter, busclose_first_counter, no_sip_most_pop_counter,
                  busopen_most_pop_counter, sip_1, sip_2, sip_n1, bus_1, bus_2, bus_n1,
                  no_sip_1, no_sip_2, no_sip_n1, no_bus_1, no_bus_2, no_bus_n1),
                ~ ifelse(is.na(.), 0, .)))
```


```{r}
# Anticipation effects

# business closure
depression_1 <- felm(log(hps_depression) ~ #relevel(factor(c2_counter), ref = "-1"):c2_treat  +
               i(c2_counter, c2_treat, ref = -1) + 
               c2_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20, weights = hps_all_v20$pop)

# depression_1 <- felm(log(hps_depression) ~ 
#               i(c2_counter, c2_treat, ref = -1) +
#                c2_future + 
#                initclaims_combined + 
#                contclaims_combined + cases_per_100k_5day + 
#                factor(e1_income_support) + factor(e2_debt_contract_relief) + 
#                 log(covid_norm+1) + log(lockdown_norm+1)
#              |factor(state) + factor(year) + factor(period)|0|state,
#              data = hps_all_v20,
#              weights = hps_all_v20$pop)

anxiety_1 <- felm(log(hps_anxiety) ~ i(c2_counter, c2_treat, ref = -1) +
               c2_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20, weights = hps_all_v20$pop)

# school closure

depression_1 <- felm(log(hps_depression) ~ #relevel(factor(c1_counter), ref = "-1")  +
              i(c1_counter, c1_treat, ref = -1) + 
               c1_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20, weights = hps_all_v20$pop)

# depression_1 <- felm(log(hps_depression) ~ i(c1_counter, c1_treat, ref = -1) + 
#                c1_future + 
#                initclaims_combined + 
#                contclaims_combined + cases_per_100k_5day + 
#                factor(e1_income_support) + factor(e2_debt_contract_relief) + 
#                 log(covid_norm+1) + log(lockdown_norm+1)
#              |factor(state) + factor(year) + factor(period)|0|state,
#              data = hps_all_v20)

anxiety_1 <- felm(log(hps_anxiety) ~ # relevel(factor(c1_counter), ref = "-1")  +
                    i(c1_counter, c1_treat, ref = -1) +
               c1_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20, weights = hps_all_v20$pop)

# SIP

depression_1 <- felm(log(hps_depression) ~ 
                       i(c6_counter, c6_treat, ref = -1) +
               c6_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20, weights = hps_all_v20$pop)

anxiety_1 <- felm(log(hps_anxiety) ~ i(c6_counter, c6_treat, ref = -1) +
               c6_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20, weights = hps_all_v20$pop)

# new one
dep_coefs <- tidy(depression_1) %>% 
  slice(1:48) %>% 
  mutate(term = as.numeric(str_sub(term, start = 34)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Depression")

# old one
# dep_coefs <- tidy(depression_1) %>% 
#   slice(1:46) %>% 
#   mutate(term = as.numeric(str_sub(term, start = 40)),
#          ci = 1.96 * `std.error`) %>% 
#   mutate(outcome = "Depression")

# new one
anx_coefs <- tidy(anxiety_1) %>% 
  slice(1:48) %>% 
  mutate(term = as.numeric(str_sub(term, start = 34)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Anxiety")

# old one
# anx_coefs <-tidy(anxiety_1) %>% 
#   slice(1:46) %>% 
#   mutate(term = as.numeric(str_sub(term, start = 40)),
#          ci = 1.96 * `std.error`) %>% 
#   mutate(outcome = "Anxiety")

total_coefs <- rbind(dep_coefs, anx_coefs)

total_coefs %>% 
  mutate(outcome = relevel(factor(outcome), ref = "Depression")) %>% 
  ggplot(aes(x = term, y = estimate, color = outcome)) + 
    geom_line() + 
      geom_pointrange(aes(ymin=estimate-ci, ymax=estimate+ci), alpha = 0.6) + 
      geom_hline(yintercept = 0, colour = "grey60") + 
      xlim(-30, 5) + 
      theme_classic() + 
      labs(x = "Weeks vs. lockdown end",
         y = "Est. % change in symptom reports") + 
      scale_y_continuous(labels = scales::percent, limits = c(-0.1, 0.1)) + 
      facet_wrap(~outcome) + 
      theme(panel.border = element_rect(color = "black",
                                    fill = NA,
                                    size = 0.5), 
            legend.position = "none")

```

```{r}
# business closures google trends

depression_bus <- felm(I(log(depression + 1 )) ~  
                  i(busclose_first_counter, busclose_treat, ref = "-1") * year_indicator + 
                 # relevel(factor(busclose_first_counter), ref = "-1") * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

anxiety_bus <- felm(I(log(anxiety + 1 )) ~  
                      i(busclose_first_counter, busclose_treat, ref = "-1") * year_indicator + 
                 # relevel(factor(busclose_first_counter), ref = "-1") * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

# new
dep_coefs <- tidy(depression_bus) %>% 
  slice(69:121) %>% 
  mutate(term = as.numeric(str_sub(term, start = 54, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Depression")

# old 
# dep_coefs <- tidy(depression_bus) %>% 
#   slice(69:121) %>% 
#   mutate(term = as.numeric(str_sub(term, start = 52, end = str_length(term)-15)),
#          ci = 1.96 * `std.error`) %>% 
#   mutate(outcome = "Depression")

# new
anx_coefs <- tidy(anxiety_bus) %>% 
  slice(69:121) %>% 
  mutate(term = as.numeric(str_sub(term, start = 54, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Anxiety")

# old
# anx_coefs <- tidy(anxiety_bus) %>% 
#   slice(69:121) %>% 
#   mutate(term = as.numeric(str_sub(term, start = 52, end = str_length(term)-15)),
#          ci = 1.96 * `std.error`) %>% 
#   mutate(outcome = "Anxiety")

total_coefs <- rbind(dep_coefs, anx_coefs)

total_coefs %>% 
  mutate(outcome = relevel(factor(outcome), ref = "Depression")) %>% 
  ggplot(aes(x = term, y = estimate, color = outcome)) + 
    geom_line() + 
      geom_pointrange(aes(ymin=estimate-ci, ymax=estimate+ci), alpha = 0.6) + 
      geom_hline(yintercept = 0, colour = "grey60") +
      theme_classic() + 
      labs(x = "Weeks vs. lockdown start",
         y = "Est. % change in searches") + 
      scale_y_continuous(labels = scales::percent, limits = c(-0.2, 0.15)) + 
      facet_wrap(~outcome) + 
      theme(panel.border = element_rect(color = "black",
                                    fill = NA,
                                    size = 0.5), 
            legend.position = "none")
```


```{r}
# business closure end

depression_bus <- felm(I(log(depression + 1 )) ~  
                 i(busopen_most_pop_counter, busopen_treat, ref = "-1") * year_indicator + 
                busclose_first * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

anxiety_bus <- felm(I(log(anxiety + 1 )) ~  
                 i(busopen_most_pop_counter, busopen_treat, ref = "-1") * year_indicator + 
                busclose_first * year_indicator  + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

dep_coefs <- tidy(depression_bus) %>% 
  slice(77:137) %>% 
  mutate(term = as.numeric(str_sub(term, start = 55, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Depression")

anx_coefs <- tidy(anxiety_bus) %>% 
  slice(77:137) %>% 
  mutate(term = as.numeric(str_sub(term, start = 55, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Anxiety")

total_coefs <- rbind(dep_coefs, anx_coefs)

total_coefs %>% 
  mutate(outcome = relevel(factor(outcome), ref = "Depression")) %>% 
  ggplot(aes(x = term, y = estimate, color = outcome)) + 
    geom_line() + 
      geom_pointrange(aes(ymin=estimate-ci, ymax=estimate+ci), alpha = 0.6) + 
      geom_hline(yintercept = 0, colour = "grey60") +
      theme_classic() + 
      labs(x = "Weeks vs. lockdown end",
         y = "Est. % change in searches") + 
      scale_y_continuous(labels = scales::percent, limits = c(-0.2, 0.15)) + 
      xlim(-20, NA) + 
      facet_wrap(~outcome) + 
      theme(panel.border = element_rect(color = "black",
                                    fill = NA,
                                    size = 0.5), 
            legend.position = "none")

```

```{r}
# start w/ index

depression_bus <- felm(I(log(0.485*crying + 0.782*depression + 
                                0.127*lonely + 0.320*sad + 0.184*tired + 1)) ~  
                 i(busclose_first_counter, busclose_treat, ref = "-1") * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

anxiety_bus <- felm(I(log(0.924 * anxiety + 0.213 * nervous + 
                                0.133 * stress + 0.198 * worry + 0.211 * panic + 1)) ~  
                 i(busclose_first_counter, busclose_treat, ref = "-1") * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

dep_coefs <- tidy(depression_bus) %>% 
  slice(69:121) %>% 
  mutate(term = as.numeric(str_sub(term, start = 54, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Depression")

anx_coefs <- tidy(anxiety_bus) %>% 
  slice(69:121) %>% 
  mutate(term = as.numeric(str_sub(term, start = 54, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Anxiety")

total_coefs <- rbind(dep_coefs, anx_coefs)

total_coefs %>% 
  mutate(outcome = relevel(factor(outcome), ref = "Depression")) %>% 
  ggplot(aes(x = term, y = estimate, color = outcome)) + 
    geom_line() + 
      geom_pointrange(aes(ymin=estimate-ci, ymax=estimate+ci), alpha = 0.6) + 
      geom_hline(yintercept = 0, colour = "grey60") +
      theme_classic() + 
      labs(x = "Weeks vs. lockdown start",
         y = "Est. % change in searches") + 
      scale_y_continuous(labels = scales::percent, limits = c(-0.2, 0.1)) + 
      xlim(NA, 30) + 
      facet_wrap(~outcome) + 
      theme(panel.border = element_rect(color = "black",
                                    fill = NA,
                                    size = 0.5), 
            legend.position = "none")
```

```{r}

# index end

depression_bus <- felm(I(log(0.485*crying + 0.782*depression + 
                                0.127*lonely + 0.320*sad + 0.184*tired + 1)) ~  
                 i(busopen_most_pop_counter, busopen_treat, ref = "-1") * year_indicator + 
                busclose_first * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

anxiety_bus <- felm(I(log(0.924 * anxiety + 0.213 * nervous + 
                                0.133 * stress + 0.198 * worry + 0.211 * panic + 1)) ~  
                 i(busopen_most_pop_counter, busopen_treat, ref = "-1") * year_indicator + 
                busclose_first * year_indicator  + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

dep_coefs <- tidy(depression_bus) %>% 
  slice(77:137) %>% 
  mutate(term = as.numeric(str_sub(term, start = 55, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Depression")

anx_coefs <- tidy(anxiety_bus) %>% 
  slice(77:137) %>% 
  mutate(term = as.numeric(str_sub(term, start = 55, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Anxiety")

total_coefs <- rbind(dep_coefs, anx_coefs)

total_coefs %>% 
  mutate(outcome = relevel(factor(outcome), ref = "Depression")) %>% 
  ggplot(aes(x = term, y = estimate, color = outcome)) + 
    geom_line() + 
      geom_pointrange(aes(ymin=estimate-ci, ymax=estimate+ci), alpha = 0.6) + 
      geom_hline(yintercept = 0, colour = "grey60") +
      theme_classic() + 
      labs(x = "Weeks vs. lockdown end",
         y = "Est. % change in searches") + 
      scale_y_continuous(labels = scales::percent, limits = c(-0.1, 0.1)) + 
      xlim(-20, 20) + 
      facet_wrap(~outcome) + 
      theme(panel.border = element_rect(color = "black",
                                    fill = NA,
                                    size = 0.5), 
            legend.position = "none")

```

```{r}
# SIp start


depression_sip <- felm(I(log(0.485*crying + 0.782*depression + 
                                0.127*lonely + 0.320*sad + 0.184*tired + 1)) ~  
                  i(sip_first_counter, sip_treat, ref = "-1") * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

anxiety_sip <- felm(I(log(0.924 * anxiety + 0.213 * nervous + 
                                0.133 * stress + 0.198 * worry + 0.211 * panic + 1)) ~  
                 i(sip_first_counter, sip_treat, ref = "-1") * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

dep_coefs <- tidy(depression_sip) %>% 
  slice(70:123) %>% 
  mutate(term = as.numeric(str_sub(term, start = 44, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Depression")

anx_coefs <- tidy(anxiety_sip) %>% 
  slice(70:123) %>% 
  mutate(term = as.numeric(str_sub(term, start = 44, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Anxiety")

total_coefs <- rbind(dep_coefs, anx_coefs)

total_coefs %>% 
  mutate(outcome = relevel(factor(outcome), ref = "Depression")) %>% 
  ggplot(aes(x = term, y = estimate, color = outcome)) + 
    geom_line() + 
      geom_pointrange(aes(ymin=estimate-ci, ymax=estimate+ci), alpha = 0.6) + 
      geom_hline(yintercept = 0, colour = "grey60") +
      theme_classic() + 
      labs(x = "Weeks vs. lockdown start",
         y = "Est. % change in searches") + 
      scale_y_continuous(labels = scales::percent, limits = c(-0.15, 0.1)) + 
      xlim(NA, 30) + 
      facet_wrap(~outcome) + 
      theme(panel.border = element_rect(color = "black",
                                    fill = NA,
                                    size = 0.5), 
            legend.position = "none")
```

```{r}

depression_sip <- felm(I(log(0.485*crying + 0.782*depression + 
                                0.127*lonely + 0.320*sad + 0.184*tired + 1)) ~  
                 i(no_sip_most_pop_counter, no_sip_treat, ref = "-1") * year_indicator + 
                sip_first * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

anxiety_sip <- felm(I(log(0.924 * anxiety + 0.213 * nervous + 
                                0.133 * stress + 0.198 * worry + 0.211 * panic + 1)) ~  
                  i(no_sip_most_pop_counter, no_sip_treat, ref = "-1") * year_indicator + 
                sip_first * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

dep_coefs <- tidy(depression_sip) %>% 
  slice(72:127) %>% 
  mutate(term = as.numeric(str_sub(term, start = 53, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Depression")

anx_coefs <- tidy(anxiety_sip) %>% 
  slice(72:127) %>% 
  mutate(term = as.numeric(str_sub(term, start = 53, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Anxiety")

total_coefs <- rbind(dep_coefs, anx_coefs)

total_coefs %>% 
  mutate(outcome = relevel(factor(outcome), ref = "Depression")) %>% 
  ggplot(aes(x = term, y = estimate, color = outcome)) + 
    geom_line() + 
      geom_pointrange(aes(ymin=estimate-ci, ymax=estimate+ci), alpha = 0.6) + 
      geom_hline(yintercept = 0, colour = "grey60") +
      theme_classic() + 
      labs(x = "Weeks vs. lockdown end",
         y = "Est. % change in searches") + 
      scale_y_continuous(labels = scales::percent, limits = c(-0.15, 0.1)) + 
      xlim(-20, 20) + 
      facet_wrap(~outcome) + 
      theme(panel.border = element_rect(color = "black",
                                    fill = NA,
                                    size = 0.5), 
            legend.position = "none")
```


```{r}
mobility_v4 <- mobility_v3 %>% 
  mutate(sipcounter_5 = sipcounter + 5,
         sipcounter_10 = sipcounter + 10,
         sipcounter_15 = sipcounter + 15,
         sipcounter_n5 = sipcounter - 5,
         no_sipcounter_5 = no_sipcounter + 5,
         no_sipcounter_10 = no_sipcounter + 10,
         no_sipcounter_15 = no_sipcounter + 15,
         no_sipcounter_n5 = no_sipcounter - 5,
         buscounter_5 = buscounter + 5,
         buscounter_10 = buscounter + 10,
         buscounter_15 = buscounter + 15,
         buscounter_n5 = buscounter - 5,
         no_buscounter_5 = no_buscounter + 5,
         no_buscounter_10 = no_buscounter + 10,
         no_buscounter_15 = no_buscounter + 15,
         no_buscounter_n5 = no_buscounter - 5,) %>% 
  mutate(sip_5 = ifelse(sipcounter_5 >= 0, 1, 0),
         sip_10 = ifelse(sipcounter_10 >= 0, 1, 0),
         sip_15 = ifelse(sipcounter_15 >= 0, 1, 0),
         sip_n5 = ifelse(sipcounter_n5 >= 0, 1, 0),
         no_sip_5 = ifelse(no_sipcounter_5 >= 0, 1, 0),
         no_sip_10 = ifelse(no_sipcounter_10 >= 0, 1, 0),
         no_sip_15 = ifelse(no_sipcounter_15 >= 0, 1, 0),
         no_sip_n5 = ifelse(no_sipcounter_n5 >= 0, 1, 0),
        bus_5 = ifelse(buscounter_5 >= 0, 1, 0),
         bus_10 = ifelse(buscounter_10 >= 0, 1, 0),
         bus_15 = ifelse(buscounter_15 >= 0, 1, 0),
         bus_n5 = ifelse(buscounter_n5 >= 0, 1, 0),
         no_bus_5 = ifelse(no_buscounter_5 > 0, 1, 0),
         no_bus_10 = ifelse(no_buscounter_10 >= 0, 1, 0),
         no_bus_15 = ifelse(no_buscounter_15 >= 0, 1, 0),
         no_bus_n5 = ifelse(no_buscounter_n5 >= 0, 1, 0),)
```

```{r}
# For state

hps_all_v20 <- hps_all_v15 %>% 
  mutate(c1_counter_1 = c1_counter + 1,
         c1_counter_2 = c1_counter + 2,
         c1_counter_3 = c1_counter + 3,
         c1_counter_n1 = c1_counter - 1,
         c2_counter_1 = c2_counter + 1,
         c2_counter_2 = c2_counter + 2,
         c2_counter_3 = c2_counter + 3,
         c2_counter_n1 = c2_counter - 1,
         c6_counter_1 = c6_counter + 1,
         c6_counter_2 = c6_counter + 2,
         c6_counter_3 = c6_counter + 3,
         c6_counter_n1 = c6_counter - 1) %>% 
  mutate(c1_post_1 = ifelse(c1_counter_1 >= 0, 1, 0),
         c1_post_2 = ifelse(c1_counter_2 >= 0, 1, 0),
         c1_post_3 = ifelse(c1_counter_3 >= 0, 1, 0),
         c1_post_n1 = ifelse(c1_counter_n1 >= 0, 1, 0),
         c2_post_1 = ifelse(c2_counter_1 >= 0, 1, 0),
         c2_post_2 = ifelse(c2_counter_2 >= 0, 1, 0),
         c2_post_3 = ifelse(c2_counter_3 >= 0, 1, 0),
         c2_post_n1 = ifelse(c2_counter_n1 >= 0, 1, 0),
         c6_post_1 = ifelse(c6_counter_1 >= 0, 1, 0),
         c6_post_2 = ifelse(c6_counter_2 >= 0, 1, 0),
         c6_post_3 = ifelse(c6_counter_3 >= 0, 1, 0),
         c6_post_n1 = ifelse(c6_counter_n1 >= 0, 1, 0))
```

```{r}
# REGRESSIONS changing lockdown window

searches_norm3_v25_5 <- searches_norm3_v22_5 %>% 
  mutate(sip_first_counter_1 = as.numeric(as.character(sip_first_counter)) + 1,
         sip_first_counter_2 = as.numeric(as.character(sip_first_counter)) + 2,
         sip_first_counter_3 = as.numeric(as.character(sip_first_counter)) + 3,
         sip_first_counter_n1 = as.numeric(as.character(sip_first_counter)) - 1,
         busclose_first_counter_1 = as.numeric(as.character(busclose_first_counter)) + 1,
         busclose_first_counter_2 = as.numeric(as.character(busclose_first_counter)) + 2,
         busclose_first_counter_3 = as.numeric(as.character(busclose_first_counter)) + 3,
         busclose_first_counter_n1 = as.numeric(as.character(busclose_first_counter)) - 1,
         no_sip_most_pop_counter_1 = as.numeric(as.character(no_sip_most_pop_counter)) + 1,
        no_sip_most_pop_counter_2 = as.numeric(as.character(no_sip_most_pop_counter)) + 2,
         no_sip_most_pop_counter_3 = as.numeric(as.character(no_sip_most_pop_counter)) + 3,
         no_sip_most_pop_counter_n1 = as.numeric(as.character(no_sip_most_pop_counter)) - 1,
        busopen_most_pop_counter_1 = as.numeric(as.character(busopen_most_pop_counter)) + 1,
         busopen_most_pop_counter_2 = as.numeric(as.character(busopen_most_pop_counter)) + 2,
         busopen_most_pop_counter_3 = as.numeric(as.character(busopen_most_pop_counter)) + 3,
         busopen_most_pop_counter_n1 = as.numeric(as.character(busopen_most_pop_counter)) - 1) %>% 
    mutate(sip_1 = ifelse(sip_first_counter_1 >= 0, 1, 0),
         sip_2 = ifelse(sip_first_counter_2 >= 0, 1, 0),
         sip_3 = ifelse(sip_first_counter_3 >= 0, 1, 0),
         sip_n1 = ifelse(sip_first_counter_n1 >= 0, 1, 0),
         no_sip_1 = ifelse(no_sip_most_pop_counter_1 >= 0, 1, 0),
         no_sip_2 = ifelse(no_sip_most_pop_counter_2 >= 0, 1, 0),
         no_sip_3 = ifelse(no_sip_most_pop_counter_3 >= 0, 1, 0),
         no_sip_n1 = ifelse(no_sip_most_pop_counter_n1 >= 0, 1, 0),
        bus_1 = ifelse(busclose_first_counter_1 >= 0, 1, 0),
         bus_2 = ifelse(busclose_first_counter_2 >= 0, 1, 0),
         bus_3 = ifelse(busclose_first_counter_3 >= 0, 1, 0),
         bus_n1 = ifelse(busclose_first_counter_n1 >= 0, 1, 0),
         no_bus_1 = ifelse(busopen_most_pop_counter_1 >= 0, 1, 0),
         no_bus_2 = ifelse(busopen_most_pop_counter_2 >= 0, 1, 0),
         no_bus_3 = ifelse(busopen_most_pop_counter_3 >= 0, 1, 0),
         no_bus_n1 = ifelse(busopen_most_pop_counter_n1 >= 0, 1, 0))

```

```{r}
# HPS, changing lockdown windows

# Depression

c1_2 <- felm(log(hps_depression) ~ c1_post_2:c1_treat + c1_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c1_1 <- felm(log(hps_depression) ~ c1_post_1:c1_treat  + c1_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c1_0 <- felm(log(hps_depression) ~ c1_post:c1_treat  + c1_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c1_n1 <- felm(log(hps_depression) ~ c1_post_n1:c1_treat  + c1_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)


c2_2 <- felm(log(hps_depression) ~ c2_post_2:c2_treat + c2_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c2_1 <- felm(log(hps_depression) ~ c2_post_1:c2_treat + c2_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c2_0 <- felm(log(hps_depression) ~ c2_post:c2_treat + c2_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c2_n1 <- felm(log(hps_depression) ~ c2_post_n1:c2_treat + c2_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c6_2 <- felm(log(hps_depression) ~ c6_post_2:c6_treat + c6_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c6_1 <- felm(log(hps_depression) ~ c6_post_1:c6_treat + c6_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c6_0 <- felm(log(hps_depression) ~ c6_post:c6_treat + c6_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c6_n1 <- felm(log(hps_depression) ~ c6_post_n1:c6_treat + c6_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

# Anxiety

c1_2 <- felm(log(hps_anxiety) ~ c1_post_2:c1_treat + c1_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c1_1 <- felm(log(hps_anxiety) ~ c1_post_1:c1_treat + c1_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c1_0 <- felm(log(hps_anxiety) ~ c1_post:c1_treat + c1_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c1_n1 <- felm(log(hps_anxiety) ~ c1_post_n1:c1_treat + c1_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)


c2_2 <- felm(log(hps_anxiety) ~ c2_post_2:c2_treat + c2_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c2_1 <- felm(log(hps_anxiety) ~ c2_post_1:c2_treat + c2_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c2_0 <- felm(log(hps_anxiety) ~ c2_post:c2_treat + c2_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c2_n1 <- felm(log(hps_anxiety) ~ c2_post_n1:c2_treat + c2_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c6_2 <- felm(log(hps_anxiety) ~ c6_post_2:c6_treat + c6_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c6_1 <- felm(log(hps_anxiety) ~ c6_post_1:c6_treat + c6_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c6_0 <- felm(log(hps_anxiety) ~ c6_post:c6_treat + c6_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c6_n1 <- felm(log(hps_anxiety) ~ c6_post_n1:c6_treat + c6_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c1_2_coef <- tidy(c1_2) %>% 
  slice(1) %>% 
  mutate(npi = "c1", delay = "2")

c1_1_coef <- tidy(c1_1) %>% 
  slice(1) %>% 
  mutate(npi = "c1", delay = "1")

c1_0_coef <- tidy(c1_0) %>% 
  slice(1) %>% 
  mutate(npi = "c1", delay = "0")

c1_n1_coef <- tidy(c1_n1) %>% 
  slice(1) %>% 
  mutate(npi = "c1", delay = "-1")

c2_2_coef <- tidy(c2_2) %>% 
  slice(1) %>% 
  mutate(npi = "c2", delay = "2")

c2_1_coef <- tidy(c2_1) %>% 
  slice(1) %>% 
  mutate(npi = "c2", delay = "1")

c2_0_coef <- tidy(c2_0) %>% 
  slice(1) %>% 
  mutate(npi = "c2", delay = "0")

c2_n1_coef <- tidy(c2_n1) %>% 
  slice(1) %>% 
  mutate(npi = "c2", delay = "-1")

c6_2_coef <- tidy(c6_2) %>% 
  slice(1) %>% 
  mutate(npi = "c6", delay = "2")

c6_1_coef <- tidy(c6_1) %>% 
  slice(1) %>% 
  mutate(npi = "c6", delay = "1")

c6_0_coef <- tidy(c6_0) %>% 
  slice(1) %>% 
  mutate(npi = "c6", delay = "0")

c6_n1_coef <- tidy(c6_n1) %>% 
  slice(1) %>% 
  mutate(npi = "c6", delay = "-1")

total_coefs <- rbind(c1_10_coef, c1_5_coef, c1_0_coef, c1_n5_coef,
                     c2_10_coef, c2_5_coef, c2_0_coef, c2_n5_coef,
                     c6_10_coef, c6_5_coef, c6_0_coef, c6_n5_coef)

total_coefs %>% 
  ggplot(aes(y = ordered(delay, levels = c("-5", "0", "5", "10")),
             x = estimate, color = npi)) + 
    geom_pointrange(aes(
      xmin = estimate - 1.96 * std.error,
      xmax = estimate + 1.96 * std.error
    ),
    alpha = 0.6) + 
    theme_classic(base_size = 13) + 
    scale_color_discrete(name = "NPI type",
                         labels = c("School closure",
                                    "Business closure",
                                    "Stay-at-home order")) + 
    theme(legend.position = "top") + 
    scale_y_discrete(labels = c("1 week after",
                                   "Actual",
                                   "1 week before",
                                   "2 weeks before")) + 
     scale_x_continuous(labels = scales::percent) + 
    labs(x = "Est. % change in reported symptoms", y = "")

htmlreg(l = list(c1_2, c1_1, c1_0, c1_n1),
        include.ci = FALSE, digits = 4, file = "school.doc")

htmlreg(l = list(c2_2, c2_1, c2_0, c2_n1),
        include.ci = FALSE, digits = 4, file = "bus.doc")

htmlreg(l = list(c6_2, c6_1, c6_0, c6_n1),
        include.ci = FALSE, digits = 4, file = "sip.doc")



```


```{r}
# Making a new one

bus_2 <- felm(I(log(0.485*crying + 0.782*depression + 
                                0.127*lonely + 0.320*sad + 0.184*tired + 1)) ~  
                 bus_2:busclose_treat *year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

bus_1 <- felm(I(log(0.485*crying + 0.782*depression + 
                                0.127*lonely + 0.320*sad + 0.184*tired + 1)) ~  
                 bus_1:busclose_treat*year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

bus_0 <- felm(I(log(0.485*crying + 0.782*depression + 
                                0.127*lonely + 0.320*sad + 0.184*tired + 1)) ~  
                 busclose_first * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

bus_n1 <- felm(I(log(0.485*crying + 0.782*depression + 
                                0.127*lonely + 0.320*sad + 0.184*tired + 1)) ~  
                 bus_n1:busclose_treat*year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

htmlreg(l = list(bus_2, bus_1, bus_0, bus_n1), include.ci = FALSE, digits = 4,
        file = "bus.doc")

```
```{r}
# Bus anxiety
bus_2 <- felm(I(log(0.924 * anxiety + 0.213 * nervous + 
                                0.133 * stress + 0.198 * worry + 0.211 * panic + 1)) ~  
                 bus_2:busclose_treat * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

bus_1 <- felm(I(log(0.924 * anxiety + 0.213 * nervous + 
                                0.133 * stress + 0.198 * worry + 0.211 * panic + 1)) ~  
                 bus_1:busclose_treat * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

bus_0 <- felm(I(log(0.924 * anxiety + 0.213 * nervous + 
                                0.133 * stress + 0.198 * worry + 0.211 * panic + 1)) ~  
                 busclose_first * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

bus_n1 <- felm(I(log(0.924 * anxiety + 0.213 * nervous + 
                                0.133 * stress + 0.198 * worry + 0.211 * panic + 1)) ~  
                 bus_n1:busclose_treat * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

htmlreg(l = list(bus_2, bus_1, bus_0, bus_n1), include.ci = FALSE, digits = 4,
        file = "bus.doc")
```

```{r}
# SIP depression
sip_2 <- felm(I(log(0.485*crying + 0.782*depression + 
                                0.127*lonely + 0.320*sad + 0.184*tired + 1)) ~  
                 sip_2:sip_treat * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

sip_1 <- felm(I(log(0.485*crying + 0.782*depression + 
                                0.127*lonely + 0.320*sad + 0.184*tired + 1)) ~  
                 sip_1:sip_treat * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

sip_0 <- felm(I(log(0.485*crying + 0.782*depression + 
                                0.127*lonely + 0.320*sad + 0.184*tired + 1)) ~  
                 sip_first * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

sip_n1 <- felm(I(log(0.485*crying + 0.782*depression + 
                                0.127*lonely + 0.320*sad + 0.184*tired + 1)) ~  
                 sip_n1:sip_treat * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

htmlreg(l = list(sip_2, sip_1, sip_0, sip_n1), include.ci = FALSE, digits = 4,
        file = "sip.doc")
```

```{r}
sip_2 <- felm(I(log(0.924 * anxiety + 0.213 * nervous + 
                                0.133 * stress + 0.198 * worry + 0.211 * panic + 1)) ~  
                 sip_2:sip_treat * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

sip_1 <- felm(I(log(0.924 * anxiety + 0.213 * nervous + 
                                0.133 * stress + 0.198 * worry + 0.211 * panic + 1)) ~  
                 sip_1:sip_treat * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

sip_0 <- felm(I(log(0.924 * anxiety + 0.213 * nervous + 
                                0.133 * stress + 0.198 * worry + 0.211 * panic + 1)) ~  
                 sip_first * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

sip_n1 <- felm(I(log(0.924 * anxiety + 0.213 * nervous + 
                                0.133 * stress + 0.198 * worry + 0.211 * panic + 1)) ~  
                 sip_n1:sip_treat * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

htmlreg(l = list(sip_2, sip_1, sip_0, sip_n1), include.ci = FALSE, digits = 4,
        file = "sip.doc")
```

```{r}
# Lockdown end event study

bus_2 <- felm(I(log(0.485*crying + 0.782*depression + 
                                0.127*lonely + 0.320*sad + 0.184*tired + 1)) ~  
                 busclose_first *year_indicator + 
                 no_bus_2:busopen_treat * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

bus_1 <- felm(I(log(0.485*crying + 0.782*depression + 
                                0.127*lonely + 0.320*sad + 0.184*tired + 1)) ~  
                busclose_first *year_indicator + 
                no_bus_1:busopen_treat * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

bus_0 <- felm(I(log(0.485*crying + 0.782*depression + 
                                0.127*lonely + 0.320*sad + 0.184*tired + 1)) ~  
                 busclose_first * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

bus_n1 <- felm(I(log(0.485*crying + 0.782*depression + 
                                0.127*lonely + 0.320*sad + 0.184*tired + 1)) ~  
                 busclose_first *year_indicator + 
                no_bus_n1:busopen_treat * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

htmlreg(l = list(bus_2, bus_1, bus_0, bus_n1), include.ci = FALSE, digits = 4,
        file = "bus.doc")
```



```{r}
# Mental healthcare event studies

counseling_1 <- felm(log(counseling) ~ i(c2_counter, c2_treat, ref = -1)  +
               c2_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20, weights = hps_all_v20$pop)

medication_1 <- felm(log(medication) ~ i(c2_counter, c2_treat, ref = -1)  +
               c2_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20, weights = hps_all_v20$pop)

no_counseling_1 <- felm(log(no_counseling) ~ i(c2_counter, c2_treat, ref = -1)  +
               c2_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20, weights = hps_all_v20$pop)

# school closure

counseling_1 <- felm(log(counseling) ~ i(c1_counter, c1_treat, ref = -1)  +
               c1_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20, weights = hps_all_v20$pop)

medication_1 <- felm(log(medication) ~ i(c1_counter, c1_treat, ref = -1)  +
               c1_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20, weights = hps_all_v20$pop)

no_counseling_1 <- felm(log(no_counseling) ~ i(c1_counter, c1_treat, ref = -1)  +
               c1_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20, weights = hps_all_v20$pop)

# SIP

counseling_1 <- felm(log(counseling) ~ i(c6_counter, c6_treat, ref = -1)  +
               c6_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20)

medication_1 <- felm(log(medication) ~ i(c6_counter, c6_treat, ref = -1)  +
               c6_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20)

no_counseling_1 <- felm(log(no_counseling) ~ i(c6_counter, c6_treat, ref = -1)  +
               c6_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20)

counseling_coefs <- tidy(counseling_1) %>% 
  slice(1:46) %>% 
  mutate(term = as.numeric(str_sub(term, start = 34)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Counseling")

medication_coefs <-tidy(medication_1) %>% 
  slice(1:46) %>% 
  mutate(term = as.numeric(str_sub(term, start = 34)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Medication")

no_counseling_coefs <-tidy(no_counseling_1) %>% 
  slice(1:46) %>% 
  mutate(term = as.numeric(str_sub(term, start = 34)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "No Counseling")

total_coefs <- rbind(counseling_coefs, medication_coefs, no_counseling_coefs)

total_coefs %>% 
  mutate(outcome = relevel(factor(outcome), ref = "Counseling")) %>% 
  ggplot(aes(x = term, y = estimate, color = outcome)) + 
    geom_line() + 
      geom_pointrange(aes(ymin=estimate-ci, ymax=estimate+ci), alpha = 0.6) + 
      geom_hline(yintercept = 0, colour = "grey60") + 
      xlim(-20, NA) + 
      theme_classic() + 
      labs(x = "Weeks vs. lockdown end",
         y = "Est. % change in positive responses") + 
      scale_y_continuous(labels = scales::percent, limits = c(-0.2, 0.2)) + 
      facet_wrap(~outcome) + 
      theme(panel.border = element_rect(color = "black",
                                    fill = NA,
                                    size = 0.5), 
            legend.position = "none")


```

```{r}
# Event study, for mental health searches 

therapy_bus <- felm(I(log(therapy + 1 )) ~  
                      i(busclose_first_counter, busclose_treat, ref = -1) * year_indicator + 
                 # relevel(factor(busclose_first_counter), ref = "-1") * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

therapy_bus_2 <- felm(I(log(therapy + 1 )) ~  
                 i(busopen_most_pop_counter, busopen_treat, ref = -1) * year_indicator + 
                busclose_first * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))
             
             
# yoga_bus <- felm(I(log(yoga + 1 )) ~  
#                  relevel(factor(busclose_first_counter), ref = "-1") * year_indicator + 
#                 busopen_most_pop * year_indicator + 
#                         online_only * year_indicator + 
#                         hybrid * year_indicator + 
#                         other * year_indicator + 
#                         cases_per_100k + unemploy_rate + temp + precip + 
#                        log(lockdown + 1) + log(covid + 1) + 
#                        factor(income_support) + factor(debt_contract_relief)
#                        |factor(week) + factor(dma):factor(year)|0|dma, 
#              weights = na.omit(searches_norm3_v22_5$pop),
#                   data = searches_norm3_v22_5 %>% filter(is.na(pop) == FALSE))

therapy_coefs <- tidy(therapy_bus) %>% 
  slice(69:121) %>% 
  mutate(term = as.numeric(str_sub(term, start = 52, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Closure Start")

therapy_coefs_2 <- tidy(therapy_bus_2) %>% 
  slice(77:137) %>% 
  mutate(term = as.numeric(str_sub(term, start = 53, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Closure End")

# yoga_coefs <- tidy(yoga_bus) %>% 
#   slice(69:121) %>% 
#   mutate(term = as.numeric(str_sub(term, start = 52, end = str_length(term)-15)),
#          ci = 1.96 * `std.error`) %>% 
#   mutate(outcome = "Yoga")

total_coefs <- rbind(therapy_coefs, therapy_coefs_2)

total_coefs %>% 
  mutate(outcome = relevel(factor(outcome), ref = "Closure Start")) %>% 
  ggplot(aes(x = term, y = estimate, color = outcome)) + 
    geom_line() + 
      geom_pointrange(aes(ymin=estimate-ci, ymax=estimate+ci), alpha = 0.6) + 
      geom_hline(yintercept = 0, colour = "grey60") +
      theme_classic() + 
      labs(x = "Weeks vs. lockdown change",
         y = "Est. % change in searches") + 
      scale_y_continuous(labels = scales::percent, limits = c(-0.2, 0.1)) + 
      xlim(-15, 20) + 
      facet_wrap(~outcome) + 
      theme(panel.border = element_rect(color = "black",
                                    fill = NA,
                                    size = 0.5), 
            legend.position = "none")
```

```{r}
# Business closure end

therapy_bus <- felm(I(log(therapy + 1 )) ~  
                 relevel(factor(busopen_most_pop_counter), ref = "-1") * year_indicator + 
                busclose_first * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v22_5$pop),
                  data = searches_norm3_v22_5 %>% filter(is.na(pop) == FALSE))
             
             
yoga_bus <- felm(I(log(yoga + 1 )) ~  
                relevel(factor(busopen_most_pop_counter), ref = "-1") * year_indicator + 
                busclose_first * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v22_5$pop),
                  data = searches_norm3_v22_5 %>% filter(is.na(pop) == FALSE))

therapy_coefs <- tidy(therapy_bus) %>% 
  slice(77:137) %>% 
  mutate(term = as.numeric(str_sub(term, start = 54, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Therapy")

yoga_coefs <- tidy(yoga_bus) %>% 
  slice(77:137) %>% 
  mutate(term = as.numeric(str_sub(term, start = 54, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Yoga")

total_coefs <- rbind(therapy_coefs, yoga_coefs)

total_coefs %>% 
  mutate(outcome = relevel(factor(outcome), ref = "Therapy")) %>% 
  ggplot(aes(x = term, y = estimate, color = outcome)) + 
    geom_line() + 
      geom_pointrange(aes(ymin=estimate-ci, ymax=estimate+ci), alpha = 0.6) + 
      geom_hline(yintercept = 0, colour = "grey60") +
      theme_classic() + 
      labs(x = "Weeks vs. lockdown end",
         y = "Est. % change in searches") + 
      scale_y_continuous(labels = scales::percent, limits = c(-0.2, 0.2)) + 
      xlim(-20, 20) + 
      facet_wrap(~outcome) + 
      theme(panel.border = element_rect(color = "black",
                                    fill = NA,
                                    size = 0.5), 
            legend.position = "none")
```

```{r}
# SIp start


therapy_sip <- felm(I(log(therapy + 1)) ~  
                 i(sip_first_counter, sip_treat, ref = -1) * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

# yoga_sip <- felm(I(log(yoga + 1)) ~  
#                  relevel(factor(sip_first_counter), ref = "-1") * year_indicator + 
#                 no_sip_most_pop * year_indicator + 
#                         online_only * year_indicator + 
#                         hybrid * year_indicator + 
#                         other * year_indicator + 
#                         cases_per_100k + unemploy_rate + temp + precip + 
#                        log(lockdown + 1) + log(covid + 1) + 
#                        factor(income_support) + factor(debt_contract_relief)
#                        |factor(week) + factor(dma):factor(year)|0|dma, 
#              weights = na.omit(searches_norm3_v22_5$pop),
#                   data = searches_norm3_v22_5 %>% filter(is.na(pop) == FALSE))

therapy_sip_2 <- felm(I(log(therapy + 1)) ~  
                  i(no_sip_most_pop_counter, no_sip_treat, ref = -1) * year_indicator + 
                sip_first * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

therapy_coefs_2 <- tidy(therapy_sip_2) %>% 
  slice(72:127) %>% 
  mutate(term = as.numeric(str_sub(term, start = 51, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "SIP End")

therapy_coefs <- tidy(therapy_sip) %>% 
  slice(70:123) %>% 
  mutate(term = as.numeric(str_sub(term, start = 42, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "SIP Start")

# yoga_coefs <- tidy(yoga_sip) %>% 
#   slice(70:123) %>% 
#   mutate(term = as.numeric(str_sub(term, start = 47, end = str_length(term)-15)),
#          ci = 1.96 * `std.error`) %>% 
#   mutate(outcome = "Yoga")

total_coefs <- rbind(therapy_coefs, therapy_coefs_2)

total_coefs %>% 
  mutate(outcome = relevel(factor(outcome), ref = "SIP Start")) %>% 
  ggplot(aes(x = term, y = estimate, color = outcome)) + 
    geom_line() + 
      geom_pointrange(aes(ymin=estimate-ci, ymax=estimate+ci), alpha = 0.6) + 
      geom_hline(yintercept = 0, colour = "grey60") +
      theme_classic() + 
      labs(x = "Weeks vs. lockdown change",
         y = "Est. % change in searches") + 
      scale_y_continuous(labels = scales::percent, limits = c(-0.2, 0.1)) + 
      xlim(-15, 20) + 
      facet_wrap(~outcome) + 
      theme(panel.border = element_rect(color = "black",
                                    fill = NA,
                                    size = 0.5), 
            legend.position = "none")
```

```{r}

therapy_sip <- felm(I(log(therapy + 1)) ~  
                 relevel(factor(no_sip_most_pop_counter), ref = "-1") * year_indicator + 
                sip_first * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v22_5$pop),
                  data = searches_norm3_v22_5 %>% filter(is.na(pop) == FALSE))

yoga_sip <- felm(I(log(yoga + 1)) ~  
                  relevel(factor(no_sip_most_pop_counter), ref = "-1") * year_indicator + 
                sip_first * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v22_5$pop),
                  data = searches_norm3_v22_5 %>% filter(is.na(pop) == FALSE))

therapy_coefs <- tidy(therapy_sip) %>% 
  slice(72:127) %>% 
  mutate(term = as.numeric(str_sub(term, start = 53, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Therapy")

yoga_coefs <- tidy(yoga_sip) %>% 
  slice(72:127) %>% 
  mutate(term = as.numeric(str_sub(term, start = 53, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Yoga")

total_coefs <- rbind(therapy_coefs, yoga_coefs)

total_coefs %>% 
  mutate(outcome = relevel(factor(outcome), ref = "Therapy")) %>% 
  ggplot(aes(x = term, y = estimate, color = outcome)) + 
    geom_line() + 
      geom_pointrange(aes(ymin=estimate-ci, ymax=estimate+ci), alpha = 0.6) + 
      geom_hline(yintercept = 0, colour = "grey60") +
      theme_classic() + 
      labs(x = "Weeks vs. lockdown end",
         y = "Est. % change in searches") + 
      scale_y_continuous(labels = scales::percent, limits = c(-0.3, 0.2)) + 
      xlim(-20, 20) + 
      facet_wrap(~outcome) + 
      theme(panel.border = element_rect(color = "black",
                                    fill = NA,
                                    size = 0.5), 
            legend.position = "none")
```

```{r}
# Changing lockdown window for therapy as well

bus_2 <- felm(I(log(therapy + 1)) ~  
                 bus_2:busclose_treat * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

bus_1 <- felm(I(log(therapy + 1)) ~  
                 bus_1:busclose_treat * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

bus_0 <- felm(I(log(therapy + 1)) ~  
                 busclose_first * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

bus_n1 <- felm(I(log(therapy + 1)) ~  
                 bus_n1:busclose_treat * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

htmlreg(l = list(bus_2, bus_1, bus_0, bus_n1), include.ci = FALSE, digits = 4,
        file = "bus.doc")

sip_2 <- felm(I(log(therapy + 1)) ~  
                 sip_2:sip_treat * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

sip_1 <- felm(I(log(therapy + 1)) ~  
                 sip_1:sip_treat * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

sip_0 <- felm(I(log(therapy + 1)) ~  
                 sip_first * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

sip_n1 <- felm(I(log(therapy + 1)) ~  
                 sip_n1:sip_treat * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

htmlreg(l = list(sip_2, sip_1, sip_0, sip_n1), include.ci = FALSE, digits = 4,
        file = "sip.doc")

bus_2_coef <- tidy(bus_2) %>% 
  slice(17) %>% 
  mutate(type = "Business closure",
         delay = "2")

bus_1_coef <- tidy(bus_1) %>% 
  slice(17) %>% 
  mutate(type = "Business closure",
         delay = "1")

bus_0_coef <- tidy(bus_0) %>% 
  slice(17) %>% 
  mutate(type = "Business closure",
         delay = "0")

bus_n1_coef <- tidy(bus_n1) %>% 
  slice(17) %>% 
  mutate(type = "Business closure",
         delay = "-1")

sip_2_coef <- tidy(sip_2) %>% 
  slice(17) %>% 
  mutate(type = "SIP",
         delay = "2")

sip_1_coef <- tidy(sip_1) %>% 
  slice(17) %>% 
  mutate(type = "SIP",
         delay = "1")

sip_0_coef <- tidy(sip_0) %>% 
  slice(17) %>% 
  mutate(type = "SIP",
         delay = "0")

sip_n1_coef <- tidy(sip_n1) %>% 
  slice(17) %>% 
  mutate(type = "SIP",
         delay = "-1")

total_coefs <- rbind(bus_2_coef, bus_1_coef, bus_0_coef, bus_n1_coef,
                     sip_2_coef, sip_1_coef, sip_0_coef, sip_n1_coef)

total_coefs %>% 
  ggplot(aes(y = ordered(delay, levels = c("-1", "0", "1", "2")),
             x = estimate, color = type)) + 
    geom_pointrange(aes(
      xmin = estimate - 1.96 * std.error,
      xmax = estimate + 1.96 * std.error
    ),
    alpha = 0.6) + 
    theme_classic(base_size = 13) + 
    scale_color_discrete(name = "NPI type",
                         labels = c("Business closure",
                                    "SIP")) + 
    theme(legend.position = "top") + 
    scale_y_discrete(labels = c("1 week after",
                                   "Actual",
                                   "1 week before",
                                   "2 weeks before")) + 
     scale_x_continuous(labels = scales::percent) + 
    labs(x = "Est. % change in searches", y = "")

```

```{r}
bus_2 <- felm(I(log(therapy + 1)) ~  
                 busclose_first * year_indicator + 
                no_bus_2:busopen_treat * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

bus_1 <- felm(I(log(therapy + 1)) ~  
                 busclose_first * year_indicator + 
                no_bus_1:busopen_treat* year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

bus_0 <- felm(I(log(therapy + 1)) ~  
                 busclose_first * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

bus_n1 <- felm(I(log(therapy + 1)) ~  
                 busclose_first * year_indicator + 
                no_bus_n1:busopen_treat * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

htmlreg(l = list(bus_2, bus_1, bus_0, bus_n1), include.ci = FALSE, digits = 4,
        file = "bus.doc")

sip_2 <- felm(I(log(therapy + 1)) ~  
                 sip_first * year_indicator + 
                no_sip_2:no_sip_treat * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

sip_1 <- felm(I(log(therapy + 1)) ~  
                 sip_first * year_indicator + 
                no_sip_1:no_sip_treat * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

sip_0 <- felm(I(log(therapy + 1)) ~  
                 sip_first * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

sip_n1 <- felm(I(log(therapy + 1)) ~  
                 sip_first * year_indicator + 
                no_sip_n1:no_sip_treat * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

htmlreg(l = list(sip_2, sip_1, sip_0, sip_n1), include.ci = FALSE, digits = 4,
        file = "sip.doc")

bus_2_coef <- tidy(bus_2) %>% 
  slice(18) %>% 
  mutate(type = "Business closure",
         delay = "2")

bus_1_coef <- tidy(bus_1) %>% 
  slice(18) %>% 
  mutate(type = "Business closure",
         delay = "1")

bus_0_coef <- tidy(bus_0) %>% 
  slice(18) %>% 
  mutate(type = "Business closure",
         delay = "0")

bus_n1_coef <- tidy(bus_n1) %>% 
  slice(18) %>% 
  mutate(type = "Business closure",
         delay = "-1")

sip_2_coef <- tidy(sip_2) %>% 
  slice(18) %>% 
  mutate(type = "SIP",
         delay = "2")

sip_1_coef <- tidy(sip_1) %>% 
  slice(18) %>% 
  mutate(type = "SIP",
         delay = "1")

sip_0_coef <- tidy(sip_0) %>% 
  slice(18) %>% 
  mutate(type = "SIP",
         delay = "0")

sip_n1_coef <- tidy(sip_n1) %>% 
  slice(18) %>% 
  mutate(type = "SIP",
         delay = "-1")

total_coefs <- rbind(bus_2_coef, bus_1_coef, bus_0_coef, bus_n1_coef,
                     sip_2_coef, sip_1_coef, sip_0_coef, sip_n1_coef)

total_coefs %>% 
  ggplot(aes(y = ordered(delay, levels = c("-1", "0", "1", "2")),
             x = estimate, color = type)) + 
    geom_pointrange(aes(
      xmin = estimate - 1.96 * std.error,
      xmax = estimate + 1.96 * std.error
    ),
    alpha = 0.6) + 
    theme_classic(base_size = 13) + 
    scale_color_discrete(name = "NPI type",
                         labels = c("Business closure",
                                    "SIP")) + 
    theme(legend.position = "top") + 
    scale_y_discrete(labels = c("1 week after",
                                   "Actual",
                                   "1 week before",
                                   "2 weeks before")) + 
     scale_x_continuous(labels = scales::percent) + 
    labs(x = "Est. % change in searches", y = "")
```

```{r}
bus_2 <- felm(I(log(yoga + 1)) ~  
                 bus_2 * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

bus_1 <- felm(I(log(yoga + 1)) ~  
                 bus_1 * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

bus_0 <- felm(I(log(yoga + 1)) ~  
                 busclose_first * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

bus_n1 <- felm(I(log(yoga + 1)) ~  
                 bus_n1 * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

htmlreg(l = list(bus_2, bus_1, bus_0, bus_n1), include.ci = FALSE, digits = 4,
        file = "bus.doc")

sip_2 <- felm(I(log(yoga + 1)) ~  
                 sip_2 * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

sip_1 <- felm(I(log(yoga + 1)) ~  
                 sip_1 * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

sip_0 <- felm(I(log(yoga + 1)) ~  
                 sip_first * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

sip_n1 <- felm(I(log(yoga + 1)) ~  
                 sip_n1 * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

htmlreg(l = list(sip_2, sip_1, sip_0, sip_n1), include.ci = FALSE, digits = 4,
        file = "sip.doc")

bus_2_coef <- tidy(bus_2) %>% 
  slice(17) %>% 
  mutate(type = "Business closure",
         delay = "2")

bus_1_coef <- tidy(bus_1) %>% 
  slice(17) %>% 
  mutate(type = "Business closure",
         delay = "1")

bus_0_coef <- tidy(bus_0) %>% 
  slice(17) %>% 
  mutate(type = "Business closure",
         delay = "0")

bus_n1_coef <- tidy(bus_n1) %>% 
  slice(17) %>% 
  mutate(type = "Business closure",
         delay = "-1")

sip_2_coef <- tidy(sip_2) %>% 
  slice(17) %>% 
  mutate(type = "SIP",
         delay = "2")

sip_1_coef <- tidy(sip_1) %>% 
  slice(17) %>% 
  mutate(type = "SIP",
         delay = "1")

sip_0_coef <- tidy(sip_0) %>% 
  slice(17) %>% 
  mutate(type = "SIP",
         delay = "0")

sip_n1_coef <- tidy(sip_n1) %>% 
  slice(17) %>% 
  mutate(type = "SIP",
         delay = "-1")

total_coefs <- rbind(bus_2_coef, bus_1_coef, bus_0_coef, bus_n1_coef,
                     sip_2_coef, sip_1_coef, sip_0_coef, sip_n1_coef)

total_coefs %>% 
  ggplot(aes(y = ordered(delay, levels = c("-1", "0", "1", "2")),
             x = estimate, color = type)) + 
    geom_pointrange(aes(
      xmin = estimate - 1.96 * std.error,
      xmax = estimate + 1.96 * std.error
    ),
    alpha = 0.6) + 
    theme_classic(base_size = 13) + 
    scale_color_discrete(name = "NPI type",
                         labels = c("Business closure",
                                    "SIP")) + 
    theme(legend.position = "top") + 
    scale_y_discrete(labels = c("1 week after",
                                   "Actual",
                                   "1 week before",
                                   "2 weeks before")) + 
     scale_x_continuous(labels = scales::percent) + 
    labs(x = "Est. % change in searches", y = "")
```


```{r}
bus_2 <- felm(I(log(yoga + 1)) ~  
                 busclose_first * year_indicator + 
                no_bus_2 * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

bus_1 <- felm(I(log(yoga + 1)) ~  
                 busclose_first * year_indicator + 
                no_bus_1 * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

bus_0 <- felm(I(log(yoga + 1)) ~  
                 busclose_first * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

bus_n1 <- felm(I(log(yoga + 1)) ~  
                 busclose_first * year_indicator + 
                no_bus_n1 * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

htmlreg(l = list(bus_2, bus_1, bus_0, bus_n1), include.ci = FALSE, digits = 4,
        file = "bus.doc")

sip_2 <- felm(I(log(yoga + 1)) ~  
                 sip_first * year_indicator + 
                no_sip_2 * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

sip_1 <- felm(I(log(yoga + 1)) ~  
                 sip_first * year_indicator + 
                no_sip_1 * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

sip_0 <- felm(I(log(yoga + 1)) ~  
                 sip_first * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

sip_n1 <- felm(I(log(yoga + 1)) ~  
                 sip_first * year_indicator + 
                no_sip_n1 * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

htmlreg(l = list(sip_2, sip_1, sip_0, sip_n1), include.ci = FALSE, digits = 4,
        file = "sip.doc")

bus_2_coef <- tidy(bus_2) %>% 
  slice(18) %>% 
  mutate(type = "Business closure",
         delay = "2")

bus_1_coef <- tidy(bus_1) %>% 
  slice(18) %>% 
  mutate(type = "Business closure",
         delay = "1")

bus_0_coef <- tidy(bus_0) %>% 
  slice(18) %>% 
  mutate(type = "Business closure",
         delay = "0")

bus_n1_coef <- tidy(bus_n1) %>% 
  slice(18) %>% 
  mutate(type = "Business closure",
         delay = "-1")

sip_2_coef <- tidy(sip_2) %>% 
  slice(18) %>% 
  mutate(type = "SIP",
         delay = "2")

sip_1_coef <- tidy(sip_1) %>% 
  slice(18) %>% 
  mutate(type = "SIP",
         delay = "1")

sip_0_coef <- tidy(sip_0) %>% 
  slice(18) %>% 
  mutate(type = "SIP",
         delay = "0")

sip_n1_coef <- tidy(sip_n1) %>% 
  slice(18) %>% 
  mutate(type = "SIP",
         delay = "-1")

total_coefs <- rbind(bus_2_coef, bus_1_coef, bus_0_coef, bus_n1_coef,
                     sip_2_coef, sip_1_coef, sip_0_coef, sip_n1_coef)

total_coefs %>% 
  ggplot(aes(y = ordered(delay, levels = c("-1", "0", "1", "2")),
             x = estimate, color = type)) + 
    geom_pointrange(aes(
      xmin = estimate - 1.96 * std.error,
      xmax = estimate + 1.96 * std.error
    ),
    alpha = 0.6) + 
    theme_classic(base_size = 13) + 
    scale_color_discrete(name = "NPI type",
                         labels = c("Business closure",
                                    "SIP")) + 
    theme(legend.position = "top") + 
    scale_y_discrete(labels = c("1 week after",
                                   "Actual",
                                   "1 week before",
                                   "2 weeks before")) + 
     scale_x_continuous(labels = scales::percent) + 
    labs(x = "Est. % change in searches", y = "")
```

```{r}
# HPS, changing lockdown windows

# counseling

c1_10 <- felm(log(counseling) ~ c1_post_2:c1_treat + c1_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c1_5 <- felm(log(counseling) ~ c1_post_1:c1_treat + c1_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c1_0 <- felm(log(counseling) ~ c1_post + c1_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c1_n5 <- felm(log(counseling) ~ c1_post_n1:c1_treat + c1_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)


c2_10 <- felm(log(counseling) ~ c2_post_2:c2_treat + c2_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c2_5 <- felm(log(counseling) ~ c2_post_1:c2_treat  + c2_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c2_0 <- felm(log(counseling) ~ c2_post + c2_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c2_n5 <- felm(log(counseling) ~ c2_post_n1:c2_treat  + c2_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c6_10 <- felm(log(counseling) ~ c6_post_2:c6_treat  + c6_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c6_5 <- felm(log(counseling) ~ c6_post_1:c6_treat + c6_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c6_0 <- felm(log(counseling) ~ c6_post + c6_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c6_n5 <- felm(log(counseling) ~ c6_post_n1:c6_treat + c6_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

# medication

c1_10 <- felm(log(medication) ~ c1_post_2:c1_treat + c1_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c1_5 <- felm(log(medication) ~ c1_post_1:c1_treat + c1_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c1_0 <- felm(log(medication) ~ c1_post + c1_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c1_n5 <- felm(log(medication) ~ c1_post_n1:c1_treat + c1_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)


c2_10 <- felm(log(medication) ~ c2_post_2:c2_treat + c2_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c2_5 <- felm(log(medication) ~ c2_post_1:c2_treat + c2_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c2_0 <- felm(log(medication) ~ c2_post + c2_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c2_n5 <- felm(log(medication) ~ c2_post_n1:c2_treat + c2_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c6_10 <- felm(log(medication) ~ c6_post_2:c6_treat + c6_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c6_5 <- felm(log(medication) ~ c6_post_1:c6_treat + c6_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c6_0 <- felm(log(medication) ~ c6_post + c6_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c6_n5 <- felm(log(medication) ~ c6_post_n1:c6_treat + c6_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

# no_counseling

c1_10 <- felm(log(no_counseling) ~ c1_post_2:c1_treat + c1_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c1_5 <- felm(log(no_counseling) ~ c1_post_1:c1_treat + c1_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c1_0 <- felm(log(no_counseling) ~ c1_post + c1_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c1_n5 <- felm(log(no_counseling) ~ c1_post_n1:c1_treat + c1_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)


c2_10 <- felm(log(no_counseling) ~ c2_post_2:c2_treat + c2_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c2_5 <- felm(log(no_counseling) ~ c2_post_1:c2_treat + c2_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c2_0 <- felm(log(no_counseling) ~ c2_post + c2_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c2_n5 <- felm(log(no_counseling) ~ c2_post_n1:c2_treat + c2_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c6_10 <- felm(log(no_counseling) ~ c6_post_2:c6_treat + c6_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c6_5 <- felm(log(no_counseling) ~ c6_post_1:c6_treat + c6_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c6_0 <- felm(log(no_counseling) ~ c6_post + c6_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c6_n5 <- felm(log(no_counseling) ~ c6_post_n1:c6_treat + c6_future + 
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(state) + factor(year) + factor(period)|0|state,
             data = hps_all_v20 %>% drop_na(pop),
             weights = (hps_all_v20 %>% drop_na(pop))$pop)

c1_10_coef <- tidy(c1_10) %>% 
  slice(1) %>% 
  mutate(npi = "c1", delay = "2")

c1_5_coef <- tidy(c1_5) %>% 
  slice(1) %>% 
  mutate(npi = "c1", delay = "1")

c1_0_coef <- tidy(c1_0) %>% 
  slice(1) %>% 
  mutate(npi = "c1", delay = "0")

c1_n5_coef <- tidy(c1_0) %>% 
  slice(1) %>% 
  mutate(npi = "c1", delay = "-1")

c2_10_coef <- tidy(c2_10) %>% 
  slice(1) %>% 
  mutate(npi = "c2", delay = "2")

c2_5_coef <- tidy(c2_5) %>% 
  slice(1) %>% 
  mutate(npi = "c2", delay = "1")

c2_0_coef <- tidy(c2_0) %>% 
  slice(1) %>% 
  mutate(npi = "c2", delay = "0")

c2_n5_coef <- tidy(c2_0) %>% 
  slice(1) %>% 
  mutate(npi = "c2", delay = "-1")

c6_10_coef <- tidy(c6_10) %>% 
  slice(1) %>% 
  mutate(npi = "c6", delay = "2")

c6_5_coef <- tidy(c6_5) %>% 
  slice(1) %>% 
  mutate(npi = "c6", delay = "1")

c6_0_coef <- tidy(c6_0) %>% 
  slice(1) %>% 
  mutate(npi = "c6", delay = "0")

c6_n5_coef <- tidy(c6_0) %>% 
  slice(1) %>% 
  mutate(npi = "c6", delay = "-1")

total_coefs <- rbind(c1_10_coef, c1_5_coef, c1_0_coef, c1_n5_coef,
                     c2_10_coef, c2_5_coef, c2_0_coef, c2_n5_coef,
                     c6_10_coef, c6_5_coef, c6_0_coef, c6_n5_coef)

total_coefs %>% 
  ggplot(aes(y = ordered(delay, levels = c("-1", "0", "1", "2")),
             x = estimate, color = npi)) + 
    geom_pointrange(aes(
      xmin = estimate - 1.96 * std.error,
      xmax = estimate + 1.96 * std.error
    ),
    alpha = 0.6) + 
    theme_classic(base_size = 13) + 
    scale_color_discrete(name = "NPI type",
                         labels = c("School closure",
                                    "Business closure",
                                    "Stay-at-home order")) + 
    theme(legend.position = "top") + 
    scale_y_discrete(labels = c("1 week after",
                                   "Actual",
                                   "1 week before",
                                   "2 weeks before")) + 
     scale_x_continuous(labels = scales::percent) + 
    labs(x = "Est. % change in reported symptoms", y = "")

htmlreg(l = list(c1_10, c1_5, c1_0, c1_n5),
        include.ci = FALSE, digits = 4, file = "school.doc")

htmlreg(l = list(c2_10, c2_5, c2_0, c2_n5),
        include.ci = FALSE, digits = 4, file = "bus.doc")

htmlreg(l = list(c6_10, c6_5, c6_0, c6_n5),
        include.ci = FALSE, digits = 4, file = "sip.doc")



```


```{r}
# Substance use event study

substance_sip <- felm(I(log(0.144 * alcohol + 0.833 * cannabis + 0.451 * cigarette + 
                            0.172 * e_cig + 0.228 * smoking + 1)) ~  
                  i(sip_first_counter, sip_treat, ref = -1) * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

abuse_sip <- felm(I(log(0.308 * addiction + 0.390 * alcoholism + 0.104 * rehab + 
                             0.861 * substance_abuse+ 1)) ~  
                 i(sip_first_counter, sip_treat, ref = -1) * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

substance_coefs <- tidy(substance_sip) %>% 
  slice(70:123) %>% 
  mutate(term = as.numeric(str_sub(term, start = 42, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Substance use")

abuse_coefs <- tidy(abuse_sip) %>% 
  slice(70:123) %>% 
  mutate(term = as.numeric(str_sub(term, start = 42, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Substance misuse")

total_coefs <- rbind(substance_coefs, abuse_coefs)

total_coefs %>% 
  mutate(outcome = relevel(factor(outcome), ref = "Substance use")) %>% 
  ggplot(aes(x = term, y = estimate, color = outcome)) + 
    geom_line() + 
      geom_pointrange(aes(ymin=estimate-ci, ymax=estimate+ci), alpha = 0.6) + 
      geom_hline(yintercept = 0, colour = "grey60") +
      theme_classic() + 
      labs(x = "Weeks vs. lockdown start",
         y = "Est. % change in searches") + 
      scale_y_continuous(labels = scales::percent, limits = c(-0.3, 0.2)) + 
      xlim(NA, 20) + 
      facet_wrap(~outcome) + 
      theme(panel.border = element_rect(color = "black",
                                    fill = NA,
                                    size = 0.5), 
            legend.position = "none")
```

```{r}
# busclose event study

substance_bus <- felm(I(log(0.144 * alcohol + 0.833 * cannabis + 0.451 * cigarette + 
                            0.172 * e_cig + 0.228 * smoking + 1)) ~  
                 i(busclose_first_counter, busclose_treat, ref = -1) * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

abuse_bus <- felm(I(log(0.308 * addiction + 0.390 * alcoholism + 0.104 * rehab + 
                             0.861 * substance_abuse+ 1)) ~  
                 i(busclose_first_counter, busclose_treat, ref = -1) * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

substance_coefs <- tidy(substance_bus) %>% 
  slice(69:121) %>% 
  mutate(term = as.numeric(str_sub(term, start = 52, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Substance use")

abuse_coefs <- tidy(abuse_bus) %>% 
  slice(69:121) %>% 
  mutate(term = as.numeric(str_sub(term, start = 52, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Substance misuse")

total_coefs <- rbind(substance_coefs, abuse_coefs)

total_coefs %>% 
  mutate(outcome = relevel(factor(outcome), ref = "Substance use")) %>% 
  ggplot(aes(x = term, y = estimate, color = outcome)) + 
    geom_line() + 
      geom_pointrange(aes(ymin=estimate-ci, ymax=estimate+ci), alpha = 0.6) + 
      geom_hline(yintercept = 0, colour = "grey60") +
      theme_classic() + 
      labs(x = "Weeks vs. lockdown start",
         y = "Est. % change in searches") + 
      scale_y_continuous(labels = scales::percent) + 
      xlim(NA, 20) + 
      facet_wrap(~outcome) + 
      theme(panel.border = element_rect(color = "black",
                                    fill = NA,
                                    size = 0.5), 
            legend.position = "none")
```

```{r}
# busopen event study

substance_bus <- felm(I(log(0.144 * alcohol + 0.833 * cannabis + 0.451 * cigarette + 
                            0.172 * e_cig + 0.228 * smoking + 1)) ~  
                 i(busopen_most_pop_counter, busopen_treat, ref = -1) * year_indicator + 
                busclose_first * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

abuse_bus <- felm(I(log(0.308 * addiction + 0.390 * alcoholism + 0.104 * rehab + 
                             0.861 * substance_abuse+ 1)) ~  
                 i(busopen_most_pop_counter, busopen_treat, ref = -1) * year_indicator + 
                busclose_first * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

substance_coefs <- tidy(substance_bus) %>% 
  slice(77:137) %>% 
  mutate(term = as.numeric(str_sub(term, start = 53, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Substance use")

abuse_coefs <- tidy(abuse_bus) %>% 
  slice(77:137) %>% 
  mutate(term = as.numeric(str_sub(term, start = 53, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Substance misuse")

total_coefs <- rbind(substance_coefs, abuse_coefs)

total_coefs %>% 
  mutate(outcome = relevel(factor(outcome), ref = "Substance use")) %>% 
  ggplot(aes(x = term, y = estimate, color = outcome)) + 
    geom_line() + 
      geom_pointrange(aes(ymin=estimate-ci, ymax=estimate+ci), alpha = 0.6) + 
      geom_hline(yintercept = 0, colour = "grey60") +
      theme_classic() + 
      labs(x = "Weeks vs. lockdown end",
         y = "Est. % change in searches") + 
      scale_y_continuous(labels = scales::percent, limits = c(-0.15, 0.2)) + 
      xlim(-20, 20) + 
      facet_wrap(~outcome) + 
      theme(panel.border = element_rect(color = "black",
                                    fill = NA,
                                    size = 0.5), 
            legend.position = "none")
```

```{r}
# Changing up lockdown dates

bus_2 <- felm(I(log(0.144 * alcohol + 0.833 * cannabis + 0.451 * cigarette + 
                            0.172 * e_cig + 0.228 * smoking + 1)) ~  
                 bus_2:busclose_treat * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

bus_1 <- felm(I(log(0.144 * alcohol + 0.833 * cannabis + 0.451 * cigarette + 
                            0.172 * e_cig + 0.228 * smoking + 1)) ~  
                 bus_1:busclose_treat * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

bus_0 <- felm(I(log(0.144 * alcohol + 0.833 * cannabis + 0.451 * cigarette + 
                            0.172 * e_cig + 0.228 * smoking + 1)) ~  
                 busclose_first * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

bus_n1 <- felm(I(log(0.144 * alcohol + 0.833 * cannabis + 0.451 * cigarette + 
                            0.172 * e_cig + 0.228 * smoking + 1)) ~  
                 bus_n1:busclose_treat * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

htmlreg(l = list(bus_2, bus_1, bus_0, bus_n1), include.ci = FALSE, digits = 4,
        file = "bus.doc")

```

```{r}
# Bus misuse
bus_2 <- felm(I(log(0.308 * addiction + 0.390 * alcoholism + 0.104 * rehab + 
                             0.861 * substance_abuse+ 1)) ~  
                 bus_2:busclose_treat * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

bus_1 <- felm(I(log(0.308 * addiction + 0.390 * alcoholism + 0.104 * rehab + 
                             0.861 * substance_abuse+ 1)) ~  
                 bus_1:busclose_treat * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

bus_0 <- felm(I(log(0.308 * addiction + 0.390 * alcoholism + 0.104 * rehab + 
                             0.861 * substance_abuse+ 1)) ~  
                 busclose_first * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

bus_n1 <- felm(I(log(0.308 * addiction + 0.390 * alcoholism + 0.104 * rehab + 
                             0.861 * substance_abuse+ 1)) ~  
                 bus_n1:busclose_treat * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

htmlreg(l = list(bus_2, bus_1, bus_0, bus_n1), include.ci = FALSE, digits = 4,
        file = "bus.doc")


```

```{r}
# SIP depression
sip_2 <- felm(I(log(0.144 * alcohol + 0.833 * cannabis + 0.451 * cigarette + 
                            0.172 * e_cig + 0.228 * smoking + 1)) ~  
                 sip_2:sip_treat * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

sip_1 <- felm(I(log(0.144 * alcohol + 0.833 * cannabis + 0.451 * cigarette + 
                            0.172 * e_cig + 0.228 * smoking + 1)) ~  
                 sip_1:sip_treat * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

sip_0 <- felm(I(log(0.144 * alcohol + 0.833 * cannabis + 0.451 * cigarette + 
                            0.172 * e_cig + 0.228 * smoking + 1)) ~  
                 sip_first * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

sip_n1 <- felm(I(log(0.144 * alcohol + 0.833 * cannabis + 0.451 * cigarette + 
                            0.172 * e_cig + 0.228 * smoking + 1)) ~  
                 sip_n1:sip_treat * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

htmlreg(l = list(sip_2, sip_1, sip_0, sip_n1), include.ci = FALSE, digits = 4,
        file = "sip.doc")

bus_2_coef <- tidy(bus_2) %>% 
  slice(17) %>% 
  mutate(type = "Business closure",
         delay = "2")

bus_1_coef <- tidy(bus_1) %>% 
  slice(17) %>% 
  mutate(type = "Business closure",
         delay = "1")

bus_0_coef <- tidy(bus_0) %>% 
  slice(17) %>% 
  mutate(type = "Business closure",
         delay = "0")

bus_n1_coef <- tidy(bus_n1) %>% 
  slice(17) %>% 
  mutate(type = "Business closure",
         delay = "-1")

sip_2_coef <- tidy(sip_2) %>% 
  slice(17) %>% 
  mutate(type = "SIP",
         delay = "2")

sip_1_coef <- tidy(sip_1) %>% 
  slice(17) %>% 
  mutate(type = "SIP",
         delay = "1")

sip_0_coef <- tidy(sip_0) %>% 
  slice(17) %>% 
  mutate(type = "SIP",
         delay = "0")

sip_n1_coef <- tidy(sip_n1) %>% 
  slice(17) %>% 
  mutate(type = "SIP",
         delay = "-1")

total_coefs <- rbind(bus_2_coef, bus_1_coef, bus_0_coef, bus_n1_coef,
                     sip_2_coef, sip_1_coef, sip_0_coef, sip_n1_coef)

total_coefs %>% 
  ggplot(aes(y = ordered(delay, levels = c("-1", "0", "1", "2")),
             x = estimate, color = type)) + 
    geom_pointrange(aes(
      xmin = estimate - 1.96 * std.error,
      xmax = estimate + 1.96 * std.error
    ),
    alpha = 0.6) + 
    theme_classic(base_size = 13) + 
    scale_color_discrete(name = "NPI type",
                         labels = c("Business closure",
                                    "SIP")) + 
    theme(legend.position = "top") + 
    scale_y_discrete(labels = c("1 week after",
                                   "Actual",
                                   "1 week before",
                                   "2 weeks before")) + 
     scale_x_continuous(labels = scales::percent) + 
    labs(x = "Est. % change in searches", y = "")
```

```{r}
sip_2 <- felm(I(log(0.308 * addiction + 0.390 * alcoholism + 0.104 * rehab + 
                             0.861 * substance_abuse+ 1)) ~  
                 sip_2:sip_treat * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

sip_1 <- felm(I(log(0.308 * addiction + 0.390 * alcoholism + 0.104 * rehab + 
                             0.861 * substance_abuse+ 1)) ~  
                 sip_1:sip_treat * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

sip_0 <- felm(I(log(0.308 * addiction + 0.390 * alcoholism + 0.104 * rehab + 
                             0.861 * substance_abuse+ 1)) ~  
                 sip_first * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

sip_n1 <- felm(I(log(0.308 * addiction + 0.390 * alcoholism + 0.104 * rehab + 
                             0.861 * substance_abuse+ 1)) ~  
                 sip_n1:sip_treat * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

htmlreg(l = list(sip_2, sip_1, sip_0, sip_n1), include.ci = FALSE, digits = 4,
        file = "sip.doc")
```


```{r}
bus_2 <- felm(I(log(0.144 * alcohol + 0.833 * cannabis + 0.451 * cigarette +                              0.172 * e_cig + 0.228 * smoking + 1)) ~  
                 busclose_first * year_indicator + 
                no_bus_2:busopen_treat * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

bus_1 <- felm(I(log(0.144 * alcohol + 0.833 * cannabis + 0.451 * cigarette +                              0.172 * e_cig + 0.228 * smoking + 1)) ~  
                 busclose_first * year_indicator + 
                no_bus_1:busopen_treat * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

bus_0 <- felm(I(log(0.144 * alcohol + 0.833 * cannabis + 0.451 * cigarette +                              0.172 * e_cig + 0.228 * smoking + 1)) ~  
                 busclose_first * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

bus_n1 <- felm(I(log(0.144 * alcohol + 0.833 * cannabis + 0.451 * cigarette +                              0.172 * e_cig + 0.228 * smoking + 1)) ~  
                 busclose_first * year_indicator + 
                no_bus_n1:busopen_treat * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

htmlreg(l = list(bus_2, bus_1, bus_0, bus_n1), include.ci = FALSE, digits = 4,
        file = "bus.doc")

sip_2 <- felm(I(log(0.144 * alcohol + 0.833 * cannabis + 0.451 * cigarette +                              0.172 * e_cig + 0.228 * smoking + 1)) ~  
                 sip_first * year_indicator + 
                no_sip_2:no_sip_treat * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

sip_1 <- felm(I(log(0.144 * alcohol + 0.833 * cannabis + 0.451 * cigarette +                              0.172 * e_cig + 0.228 * smoking + 1)) ~  
                 sip_first * year_indicator + 
                no_sip_1:no_sip_treat * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

sip_0 <- felm(I(log(0.144 * alcohol + 0.833 * cannabis + 0.451 * cigarette +                              0.172 * e_cig + 0.228 * smoking + 1)) ~  
                 sip_first * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

sip_n1 <- felm(I(log(0.144 * alcohol + 0.833 * cannabis + 0.451 * cigarette +                              0.172 * e_cig + 0.228 * smoking + 1)) ~  
                 sip_first * year_indicator + 
                no_sip_n1:no_sip_treat * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

htmlreg(l = list(sip_2, sip_1, sip_0, sip_n1), include.ci = FALSE, digits = 4,
        file = "sip.doc")

bus_2_coef <- tidy(bus_2) %>% 
  slice(18) %>% 
  mutate(type = "Business closure",
         delay = "2")

bus_1_coef <- tidy(bus_1) %>% 
  slice(18) %>% 
  mutate(type = "Business closure",
         delay = "1")

bus_0_coef <- tidy(bus_0) %>% 
  slice(18) %>% 
  mutate(type = "Business closure",
         delay = "0")

bus_n1_coef <- tidy(bus_n1) %>% 
  slice(18) %>% 
  mutate(type = "Business closure",
         delay = "-1")

sip_2_coef <- tidy(sip_2) %>% 
  slice(18) %>% 
  mutate(type = "SIP",
         delay = "2")

sip_1_coef <- tidy(sip_1) %>% 
  slice(18) %>% 
  mutate(type = "SIP",
         delay = "1")

sip_0_coef <- tidy(sip_0) %>% 
  slice(18) %>% 
  mutate(type = "SIP",
         delay = "0")

sip_n1_coef <- tidy(sip_n1) %>% 
  slice(18) %>% 
  mutate(type = "SIP",
         delay = "-1")

total_coefs <- rbind(bus_2_coef, bus_1_coef, bus_0_coef, bus_n1_coef,
                     sip_2_coef, sip_1_coef, sip_0_coef, sip_n1_coef)

total_coefs %>% 
  ggplot(aes(y = ordered(delay, levels = c("-1", "0", "1", "2")),
             x = estimate, color = type)) + 
    geom_pointrange(aes(
      xmin = estimate - 1.96 * std.error,
      xmax = estimate + 1.96 * std.error
    ),
    alpha = 0.6) + 
    theme_classic(base_size = 13) + 
    scale_color_discrete(name = "NPI type",
                         labels = c("Business closure",
                                    "SIP")) + 
    theme(legend.position = "top") + 
    scale_y_discrete(labels = c("1 week after",
                                   "Actual",
                                   "1 week before",
                                   "2 weeks before")) + 
     scale_x_continuous(labels = scales::percent) + 
    labs(x = "Est. % change in searches", y = "")
```

```{r}


bus_2 <- felm(I(log(0.308 * addiction + 0.390 * alcoholism + 0.104 * rehab +                               0.861 * substance_abuse+ 1)) ~  
                 busclose_first * year_indicator + 
                no_bus_2:busopen_treat * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

bus_1 <- felm(I(log(0.308 * addiction + 0.390 * alcoholism + 0.104 * rehab +                               0.861 * substance_abuse+ 1)) ~  
                 busclose_first * year_indicator + 
                no_bus_1:busopen_treat * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

bus_0 <- felm(I(log(0.308 * addiction + 0.390 * alcoholism + 0.104 * rehab +                               0.861 * substance_abuse+ 1)) ~  
                 busclose_first * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

bus_n1 <- felm(I(log(0.308 * addiction + 0.390 * alcoholism + 0.104 * rehab +                               0.861 * substance_abuse+ 1)) ~  
                 busclose_first * year_indicator + 
                no_bus_n1:busopen_treat * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

htmlreg(l = list(bus_2, bus_1, bus_0, bus_n1), include.ci = FALSE, digits = 4,
        file = "bus.doc")

sip_2 <- felm(I(log(0.308 * addiction + 0.390 * alcoholism + 0.104 * rehab +                               0.861 * substance_abuse+ 1)) ~  
                 sip_first * year_indicator + 
                no_sip_2:no_sip_treat * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

sip_1 <- felm(I(log(0.308 * addiction + 0.390 * alcoholism + 0.104 * rehab +                               0.861 * substance_abuse+ 1)) ~  
                 sip_first * year_indicator + 
                no_sip_1:no_sip_treat * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

sip_0 <- felm(I(log(0.308 * addiction + 0.390 * alcoholism + 0.104 * rehab +                               0.861 * substance_abuse+ 1)) ~  
                 sip_first * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

sip_n1 <- felm(I(log(0.308 * addiction + 0.390 * alcoholism + 0.104 * rehab +                               0.861 * substance_abuse+ 1)) ~  
                 sip_first * year_indicator + 
                no_sip_n1:no_sip_treat * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

htmlreg(l = list(sip_2, sip_1, sip_0, sip_n1), include.ci = FALSE, digits = 4,
        file = "sip.doc")

bus_2_coef <- tidy(bus_2) %>% 
  slice(18) %>% 
  mutate(type = "Business closure",
         delay = "2")

bus_1_coef <- tidy(bus_1) %>% 
  slice(18) %>% 
  mutate(type = "Business closure",
         delay = "1")

bus_0_coef <- tidy(bus_0) %>% 
  slice(18) %>% 
  mutate(type = "Business closure",
         delay = "0")

bus_n1_coef <- tidy(bus_n1) %>% 
  slice(18) %>% 
  mutate(type = "Business closure",
         delay = "-1")

sip_2_coef <- tidy(sip_2) %>% 
  slice(18) %>% 
  mutate(type = "SIP",
         delay = "2")

sip_1_coef <- tidy(sip_1) %>% 
  slice(18) %>% 
  mutate(type = "SIP",
         delay = "1")

sip_0_coef <- tidy(sip_0) %>% 
  slice(18) %>% 
  mutate(type = "SIP",
         delay = "0")

sip_n1_coef <- tidy(sip_n1) %>% 
  slice(18) %>% 
  mutate(type = "SIP",
         delay = "-1")

total_coefs <- rbind(bus_2_coef, bus_1_coef, bus_0_coef, bus_n1_coef,
                     sip_2_coef, sip_1_coef, sip_0_coef, sip_n1_coef)

total_coefs %>% 
  ggplot(aes(y = ordered(delay, levels = c("-1", "0", "1", "2")),
             x = estimate, color = type)) + 
    geom_pointrange(aes(
      xmin = estimate - 1.96 * std.error,
      xmax = estimate + 1.96 * std.error
    ),
    alpha = 0.6) + 
    theme_classic(base_size = 13) + 
    scale_color_discrete(name = "NPI type",
                         labels = c("Business closure",
                                    "SIP")) + 
    theme(legend.position = "top") + 
    scale_y_discrete(labels = c("1 week after",
                                   "Actual",
                                   "1 week before",
                                   "2 weeks before")) + 
     scale_x_continuous(labels = scales::percent) + 
    labs(x = "Est. % change in searches", y = "")
```


```{r}
# start w/ index and new FEs

depression_bus <- felm(I(log(0.485*crying + 0.782*depression + 
                                0.127*lonely + 0.320*sad + 0.184*tired + 1)) ~  
                 i(busclose_first_counter, busclose_treat, ref = "-1") * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

anxiety_bus <- felm(I(log(0.924 * anxiety + 0.213 * nervous + 
                                0.133 * stress + 0.198 * worry + 0.211 * panic + 1)) ~  
                 i(busclose_first_counter, busclose_treat, ref = "-1") * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

dep_coefs <- tidy(depression_bus) %>% 
  slice(69:121) %>% 
  mutate(term = as.numeric(str_sub(term, start = 54, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Depression")

anx_coefs <- tidy(anxiety_bus) %>% 
  slice(69:121) %>% 
  mutate(term = as.numeric(str_sub(term, start = 54, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Anxiety")

total_coefs <- rbind(dep_coefs, anx_coefs)

total_coefs %>% 
  mutate(outcome = relevel(factor(outcome), ref = "Depression")) %>% 
  ggplot(aes(x = term, y = estimate, color = outcome)) + 
    geom_line() + 
      geom_pointrange(aes(ymin=estimate-ci, ymax=estimate+ci), alpha = 0.6) + 
      geom_hline(yintercept = 0, colour = "grey60") +
      theme_classic() + 
      labs(x = "Weeks vs. lockdown start",
         y = "Est. % change in searches") + 
      scale_y_continuous(labels = scales::percent, limits = c(-0.2, 0.1)) + 
      xlim(NA, 30) + 
      facet_wrap(~outcome) + 
      theme(panel.border = element_rect(color = "black",
                                    fill = NA,
                                    size = 0.5), 
            legend.position = "none")
```

```{r}

# index end

depression_bus <- felm(I(log(0.485*crying + 0.782*depression + 
                                0.127*lonely + 0.320*sad + 0.184*tired + 1)) ~  
                 i(busopen_most_pop_counter, busopen_treat, ref = "-1") * year_indicator + 
                busclose_first * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

anxiety_bus <- felm(I(log(0.924 * anxiety + 0.213 * nervous + 
                                0.133 * stress + 0.198 * worry + 0.211 * panic + 1)) ~  
                 i(busopen_most_pop_counter, busopen_treat, ref = "-1") * year_indicator + 
                busclose_first * year_indicator  + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

dep_coefs <- tidy(depression_bus) %>% 
  slice(77:137) %>% 
  mutate(term = as.numeric(str_sub(term, start = 55, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Depression")

anx_coefs <- tidy(anxiety_bus) %>% 
  slice(77:137) %>% 
  mutate(term = as.numeric(str_sub(term, start = 55, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Anxiety")

total_coefs <- rbind(dep_coefs, anx_coefs)

total_coefs %>% 
  mutate(outcome = relevel(factor(outcome), ref = "Depression")) %>% 
  ggplot(aes(x = term, y = estimate, color = outcome)) + 
    geom_line() + 
      geom_pointrange(aes(ymin=estimate-ci, ymax=estimate+ci), alpha = 0.6) + 
      geom_hline(yintercept = 0, colour = "grey60") +
      theme_classic() + 
      labs(x = "Weeks vs. lockdown end",
         y = "Est. % change in searches") + 
      scale_y_continuous(labels = scales::percent, limits = c(-0.1, 0.2)) + 
      xlim(-20, 20) + 
      facet_wrap(~outcome) + 
      theme(panel.border = element_rect(color = "black",
                                    fill = NA,
                                    size = 0.5), 
            legend.position = "none")

```

```{r}
# SIp start


depression_sip <- felm(I(log(0.485*crying + 0.782*depression + 
                                0.127*lonely + 0.320*sad + 0.184*tired + 1)) ~  
                  i(sip_first_counter, sip_treat, ref = "-1") * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

anxiety_sip <- felm(I(log(0.924 * anxiety + 0.213 * nervous + 
                                0.133 * stress + 0.198 * worry + 0.211 * panic + 1)) ~  
                 i(sip_first_counter, sip_treat, ref = "-1") * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

dep_coefs <- tidy(depression_sip) %>% 
  slice(70:123) %>% 
  mutate(term = as.numeric(str_sub(term, start = 44, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Depression")

anx_coefs <- tidy(anxiety_sip) %>% 
  slice(70:123) %>% 
  mutate(term = as.numeric(str_sub(term, start = 44, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Anxiety")

total_coefs <- rbind(dep_coefs, anx_coefs)

total_coefs %>% 
  mutate(outcome = relevel(factor(outcome), ref = "Depression")) %>% 
  ggplot(aes(x = term, y = estimate, color = outcome)) + 
    geom_line() + 
      geom_pointrange(aes(ymin=estimate-ci, ymax=estimate+ci), alpha = 0.6) + 
      geom_hline(yintercept = 0, colour = "grey60") +
      theme_classic() + 
      labs(x = "Weeks vs. lockdown start",
         y = "Est. % change in searches") + 
      scale_y_continuous(labels = scales::percent, limits = c(-0.15, 0.1)) + 
      xlim(NA, 30) + 
      facet_wrap(~outcome) + 
      theme(panel.border = element_rect(color = "black",
                                    fill = NA,
                                    size = 0.5), 
            legend.position = "none")
```

```{r}

depression_sip <- felm(I(log(0.485*crying + 0.782*depression + 
                                0.127*lonely + 0.320*sad + 0.184*tired + 1)) ~  
                 i(no_sip_most_pop_counter, no_sip_treat, ref = "-1") * year_indicator + 
                sip_first * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

anxiety_sip <- felm(I(log(0.924 * anxiety + 0.213 * nervous + 
                                0.133 * stress + 0.198 * worry + 0.211 * panic + 1)) ~  
                  i(no_sip_most_pop_counter, no_sip_treat, ref = "-1") * year_indicator + 
                sip_first * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

dep_coefs <- tidy(depression_sip) %>% 
  slice(72:127) %>% 
  mutate(term = as.numeric(str_sub(term, start = 53, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Depression")

anx_coefs <- tidy(anxiety_sip) %>% 
  slice(72:127) %>% 
  mutate(term = as.numeric(str_sub(term, start = 53, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Anxiety")

total_coefs <- rbind(dep_coefs, anx_coefs)

total_coefs %>% 
  mutate(outcome = relevel(factor(outcome), ref = "Depression")) %>% 
  ggplot(aes(x = term, y = estimate, color = outcome)) + 
    geom_line() + 
      geom_pointrange(aes(ymin=estimate-ci, ymax=estimate+ci), alpha = 0.6) + 
      geom_hline(yintercept = 0, colour = "grey60") +
      theme_classic() + 
      labs(x = "Weeks vs. lockdown end",
         y = "Est. % change in searches") + 
      scale_y_continuous(labels = scales::percent, limits = c(-0.15, 0.15)) + 
      xlim(-20, 20) + 
      facet_wrap(~outcome) + 
      theme(panel.border = element_rect(color = "black",
                                    fill = NA,
                                    size = 0.5), 
            legend.position = "none")
```


```{r}
# New FEs
# Event study, for mental health searches 

therapy_bus <- felm(I(log(therapy + 1 )) ~  
                      i(busclose_first_counter, busclose_treat, ref = -1) * year_indicator + 
                 # relevel(factor(busclose_first_counter), ref = "-1") * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

therapy_bus_2 <- felm(I(log(therapy + 1 )) ~  
                 i(busopen_most_pop_counter, busopen_treat, ref = -1) * year_indicator + 
                busclose_first * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))
             
             
# yoga_bus <- felm(I(log(yoga + 1 )) ~  
#                  relevel(factor(busclose_first_counter), ref = "-1") * year_indicator + 
#                 busopen_most_pop * year_indicator + 
#                         online_only * year_indicator + 
#                         hybrid * year_indicator + 
#                         other * year_indicator + 
#                         cases_per_100k + unemploy_rate + temp + precip + 
#                        log(lockdown + 1) + log(covid + 1) + 
#                        factor(income_support) + factor(debt_contract_relief)
#                        |factor(week) + factor(dma):factor(year)|0|dma, 
#              weights = na.omit(searches_norm3_v22_5$pop),
#                   data = searches_norm3_v22_5 %>% filter(is.na(pop) == FALSE))

therapy_coefs <- tidy(therapy_bus) %>% 
  slice(69:121) %>% 
  mutate(term = as.numeric(str_sub(term, start = 52, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Closure Start")

therapy_coefs_2 <- tidy(therapy_bus_2) %>% 
  slice(77:137) %>% 
  mutate(term = as.numeric(str_sub(term, start = 53, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Closure End")

# yoga_coefs <- tidy(yoga_bus) %>% 
#   slice(69:121) %>% 
#   mutate(term = as.numeric(str_sub(term, start = 52, end = str_length(term)-15)),
#          ci = 1.96 * `std.error`) %>% 
#   mutate(outcome = "Yoga")

total_coefs <- rbind(therapy_coefs, therapy_coefs_2)

total_coefs %>% 
  mutate(outcome = relevel(factor(outcome), ref = "Closure Start")) %>% 
  ggplot(aes(x = term, y = estimate, color = outcome)) + 
    geom_line() + 
      geom_pointrange(aes(ymin=estimate-ci, ymax=estimate+ci), alpha = 0.6) + 
      geom_hline(yintercept = 0, colour = "grey60") +
      theme_classic() + 
      labs(x = "Weeks vs. lockdown change",
         y = "Est. % change in searches") + 
      scale_y_continuous(labels = scales::percent, limits = c(-0.2, 0.12)) + 
      xlim(-15, 20) + 
      facet_wrap(~outcome) + 
      theme(panel.border = element_rect(color = "black",
                                    fill = NA,
                                    size = 0.5), 
            legend.position = "none")
```


```{r}
# SIp start


therapy_sip <- felm(I(log(therapy + 1)) ~  
                 i(sip_first_counter, sip_treat, ref = -1) * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

# yoga_sip <- felm(I(log(yoga + 1)) ~  
#                  relevel(factor(sip_first_counter), ref = "-1") * year_indicator + 
#                 no_sip_most_pop * year_indicator + 
#                         online_only * year_indicator + 
#                         hybrid * year_indicator + 
#                         other * year_indicator + 
#                         cases_per_100k + unemploy_rate + temp + precip + 
#                        log(lockdown + 1) + log(covid + 1) + 
#                        factor(income_support) + factor(debt_contract_relief)
#                        |factor(week) + factor(dma):factor(year)|0|dma, 
#              weights = na.omit(searches_norm3_v22_5$pop),
#                   data = searches_norm3_v22_5 %>% filter(is.na(pop) == FALSE))

therapy_sip_2 <- felm(I(log(therapy + 1)) ~  
                  i(no_sip_most_pop_counter, no_sip_treat, ref = -1) * year_indicator + 
                sip_first * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

therapy_coefs_2 <- tidy(therapy_sip_2) %>% 
  slice(72:127) %>% 
  mutate(term = as.numeric(str_sub(term, start = 51, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "SIP End")

therapy_coefs <- tidy(therapy_sip) %>% 
  slice(70:123) %>% 
  mutate(term = as.numeric(str_sub(term, start = 42, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "SIP Start")

# yoga_coefs <- tidy(yoga_sip) %>% 
#   slice(70:123) %>% 
#   mutate(term = as.numeric(str_sub(term, start = 47, end = str_length(term)-15)),
#          ci = 1.96 * `std.error`) %>% 
#   mutate(outcome = "Yoga")

total_coefs <- rbind(therapy_coefs, therapy_coefs_2)

total_coefs %>% 
  mutate(outcome = relevel(factor(outcome), ref = "SIP Start")) %>% 
  ggplot(aes(x = term, y = estimate, color = outcome)) + 
    geom_line() + 
      geom_pointrange(aes(ymin=estimate-ci, ymax=estimate+ci), alpha = 0.6) + 
      geom_hline(yintercept = 0, colour = "grey60") +
      theme_classic() + 
      labs(x = "Weeks vs. lockdown change",
         y = "Est. % change in searches") + 
      scale_y_continuous(labels = scales::percent, limits = c(-0.2, 0.15)) + 
      xlim(-15, 20) + 
      facet_wrap(~outcome) + 
      theme(panel.border = element_rect(color = "black",
                                    fill = NA,
                                    size = 0.5), 
            legend.position = "none")
```


```{r}
# Alcohol and other substances, redone

alcohol_bus <- felm(I(log(alcohol + 1 )) ~  
                      i(busclose_first_counter, busclose_treat, ref = -1) * year_indicator + 
                 # relevel(factor(busclose_first_counter), ref = "-1") * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

cannabis_bus <- felm(I(log(cannabis + 1 )) ~  
                      i(busclose_first_counter, busclose_treat, ref = -1) * year_indicator + 
                 # relevel(factor(busclose_first_counter), ref = "-1") * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

smoking_bus <- felm(I(log(e_cig + cigarette + smoking + 1)) ~  
                      i(busclose_first_counter, busclose_treat, ref = -1) * year_indicator + 
                 # relevel(factor(busclose_first_counter), ref = "-1") * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

alcohol_coefs <- tidy(alcohol_bus) %>% 
  slice(69:121) %>% 
  mutate(term = as.numeric(str_sub(term, start = 52, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Alcohol")

smoking_coefs <- tidy(smoking_bus) %>% 
  slice(69:121) %>% 
  mutate(term = as.numeric(str_sub(term, start = 52, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Smoking")

cannabis_coefs <- tidy(cannabis_bus) %>% 
  slice(69:121) %>% 
  mutate(term = as.numeric(str_sub(term, start = 52, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Cannabis")

total_coefs <- rbind(alcohol_coefs, cannabis_coefs, smoking_coefs)


total_coefs %>% 
  mutate(outcome = relevel(factor(outcome), ref = "Alcohol")) %>% 
  ggplot(aes(x = term, y = estimate, color = outcome)) + 
    geom_line() + 
      geom_pointrange(aes(ymin=estimate-ci, ymax=estimate+ci), alpha = 0.6) + 
      geom_hline(yintercept = 0, colour = "grey60") +
      theme_classic() + 
      labs(x = "Weeks vs. lockdown start",
         y = "Est. % change in searches") + 
      scale_y_continuous(labels = scales::percent, limits = c(-0.2, 0.25)) + 
      xlim(-10, 15) + 
      facet_wrap(~outcome) + 
      theme(panel.border = element_rect(color = "black",
                                    fill = NA,
                                    size = 0.5), 
            legend.position = "none")
```

```{r}
# Substance end

alcohol_bus <- felm(I(log(alcohol + 1 )) ~  
                 i(busopen_most_pop_counter, busopen_treat, ref = -1) * year_indicator + 
                busclose_first * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

smoking_bus <- felm(I(log(e_cig + cigarette + smoking + 1 )) ~  
                 i(busopen_most_pop_counter, busopen_treat, ref = -1) * year_indicator + 
                busclose_first * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

cannabis_bus <- felm(I(log(cannabis + 1 )) ~  
                 i(busopen_most_pop_counter, busopen_treat, ref = -1) * year_indicator + 
                busclose_first * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

alcohol_coefs <- tidy(alcohol_bus) %>% 
  slice(77:137) %>% 
  mutate(term = as.numeric(str_sub(term, start = 53, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Alcohol")


cannabis_coefs <- tidy(cannabis_bus) %>% 
  slice(77:137) %>% 
  mutate(term = as.numeric(str_sub(term, start = 53, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Cannabis")


smoking_coefs <- tidy(smoking_bus) %>% 
  slice(77:137) %>% 
  mutate(term = as.numeric(str_sub(term, start = 53, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Smoking")

total_coefs <- rbind(alcohol_coefs, cannabis_coefs, smoking_coefs)


total_coefs %>% 
  mutate(outcome = relevel(factor(outcome), ref = "Alcohol")) %>% 
  ggplot(aes(x = term, y = estimate, color = outcome)) + 
    geom_line() + 
      geom_pointrange(aes(ymin=estimate-ci, ymax=estimate+ci), alpha = 0.6) + 
      geom_hline(yintercept = 0, colour = "grey60") +
      theme_classic() + 
      labs(x = "Weeks vs. lockdown end",
         y = "Est. % change in searches") + 
      scale_y_continuous(labels = scales::percent, limits = c(-0.15, 0.15)) + 
      xlim(-10, 15) + 
      facet_wrap(~outcome) + 
      theme(panel.border = element_rect(color = "black",
                                    fill = NA,
                                    size = 0.5), 
            legend.position = "none")
```
```{r}
# Do this for SIPs

alcohol_sip <- felm(I(log(alcohol + 1)) ~  
                 i(sip_first_counter, sip_treat, ref = -1) * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

smoking_sip <- felm(I(log(e_cig + cigarette + smoking + 1)) ~  
                 i(sip_first_counter, sip_treat, ref = -1) * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

cannabis_sip <- felm(I(log(cannabis + 1)) ~  
                 i(sip_first_counter, sip_treat, ref = -1) * year_indicator + 
                no_sip_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

alcohol_coefs <- tidy(alcohol_sip) %>% 
  slice(72:127) %>% 
  mutate(term = as.numeric(str_sub(term, start = 42, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Alcohol")

smoking_coefs <- tidy(smoking_sip) %>% 
  slice(72:127) %>% 
  mutate(term = as.numeric(str_sub(term, start = 42, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Smoking")

cannabis_coefs <- tidy(cannabis_sip) %>% 
  slice(72:127) %>% 
  mutate(term = as.numeric(str_sub(term, start = 42, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Cannabis")

total_coefs <- rbind(alcohol_coefs, cannabis_coefs, smoking_coefs)


total_coefs %>% 
  mutate(outcome = relevel(factor(outcome), ref = "Alcohol")) %>% 
  ggplot(aes(x = term, y = estimate, color = outcome)) + 
    geom_line() + 
      geom_pointrange(aes(ymin=estimate-ci, ymax=estimate+ci), alpha = 0.6) + 
      geom_hline(yintercept = 0, colour = "grey60") +
      theme_classic() + 
      labs(x = "Weeks vs. lockdown start",
         y = "Est. % change in searches") + 
      scale_y_continuous(labels = scales::percent, limits = c(-0.2, 0.25)) + 
      xlim(-10, 15) + 
      facet_wrap(~outcome) + 
      theme(panel.border = element_rect(color = "black",
                                    fill = NA,
                                    size = 0.5), 
            legend.position = "none")
```

```{r}
# SIP end
alcohol_sip <- felm(I(log(alcohol + 1)) ~  
                  i(no_sip_most_pop_counter, no_sip_treat, ref = -1) * year_indicator + 
                sip_first * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

cannabis_sip <- felm(I(log(cannabis + 1)) ~  
                  i(no_sip_most_pop_counter, no_sip_treat, ref = -1) * year_indicator + 
                sip_first * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

smoking_sip <- felm(I(log(smoking + e_cig + cigarette + 1)) ~  
                  i(no_sip_most_pop_counter, no_sip_treat, ref = -1) * year_indicator + 
                sip_first * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

alcohol_coefs <- tidy(alcohol_sip) %>% 
  slice(72:127) %>% 
  mutate(term = as.numeric(str_sub(term, start = 51, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Alcohol")

cannabis_coefs <- tidy(cannabis_sip) %>% 
  slice(72:127) %>% 
  mutate(term = as.numeric(str_sub(term, start = 51, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Cannabis")

smoking_coefs <- tidy(smoking_sip) %>% 
  slice(72:127) %>% 
  mutate(term = as.numeric(str_sub(term, start = 51, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Smoking")

total_coefs <- rbind(alcohol_coefs, cannabis_coefs, smoking_coefs)

total_coefs %>% 
  mutate(outcome = relevel(factor(outcome), ref = "Alcohol")) %>% 
  ggplot(aes(x = term, y = estimate, color = outcome)) + 
    geom_line() + 
      geom_pointrange(aes(ymin=estimate-ci, ymax=estimate+ci), alpha = 0.6) + 
      geom_hline(yintercept = 0, colour = "grey60") +
      theme_classic() + 
      labs(x = "Weeks vs. lockdown end",
         y = "Est. % change in searches") + 
      scale_y_continuous(labels = scales::percent, limits = c(-0.15, 0.2)) + 
      xlim(-10, 15) + 
      facet_wrap(~outcome) + 
      theme(panel.border = element_rect(color = "black",
                                    fill = NA,
                                    size = 0.5), 
            legend.position = "none")
```


```{r}
# Substance abuse start and end

abuse_bus <- felm(I(log(0.308 * addiction + 0.390 * alcoholism + 0.104 * rehab + 
                             0.861 * substance_abuse+ 1)) ~  
                 i(busclose_first_counter, busclose_treat, ref = -1) * year_indicator + 
                busopen_most_pop * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))
abuse_bus_2 <- felm(I(log(0.308 * addiction + 0.390 * alcoholism + 0.104 * rehab + 
                             0.861 * substance_abuse+ 1)) ~  
                 i(busopen_most_pop_counter, busopen_treat, ref = -1) * year_indicator + 
                busclose_first * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma):factor(year)|0|dma, 
             weights = na.omit(searches_norm3_v25_5$pop),
                  data = searches_norm3_v25_5 %>% filter(is.na(pop) == FALSE))

abuse_coefs_2 <- tidy(abuse_bus_2) %>% 
  slice(77:137) %>% 
  mutate(term = as.numeric(str_sub(term, start = 53, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Closure Start")

abuse_coefs <- tidy(abuse_bus) %>% 
  slice(69:121) %>% 
  mutate(term = as.numeric(str_sub(term, start = 52, end = str_length(term)-15)),
         ci = 1.96 * `std.error`) %>% 
  mutate(outcome = "Closure End")

total_coefs <- rbind(abuse_coefs, abuse_coefs_2)

total_coefs %>% 
  mutate(outcome = relevel(factor(outcome), ref = "Closure Start")) %>% 
  ggplot(aes(x = term, y = estimate, color = outcome)) + 
    geom_line() + 
      geom_pointrange(aes(ymin=estimate-ci, ymax=estimate+ci), alpha = 0.6) + 
      geom_hline(yintercept = 0, colour = "grey60") +
      theme_classic() + 
      labs(x = "Weeks vs. lockdown change",
         y = "Est. % change in searches") + 
      scale_y_continuous(labels = scales::percent, limits = c(-0.15, 0.2)) + 
       xlim(-10, 20) + 
      facet_wrap(~outcome) + 
      theme(panel.border = element_rect(color = "black",
                                    fill = NA,
                                    size = 0.5), 
            legend.position = "none")
```

