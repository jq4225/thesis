---
title: "survival"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(janitor)
library(readxl)
library(survival)
library(survminer)
library(htmltab)
library(lubridate)
```

```{r}

# Pull Wikipedia term limit as of February 27, 2020

term_limits <- htmltab(
  "https://en.wikipedia.org/w/index.php?title=List_of_current_United_States_governors&oldid=942828889"
  , 1) %>%
  clean_names() %>%
  select(democratic_24_republican_26_state, 
         democratic_24_republican_26_party,
         democratic_24_republican_26_end_of_term) %>%
  rename('state' = 'democratic_24_republican_26_state',
         'party' = 'democratic_24_republican_26_party',
         'end_of_term' = 'democratic_24_republican_26_end_of_term') %>%
  mutate(term_limit = ifelse(str_detect(end_of_term, pattern = "term limit"), 1, 0)) %>%
  mutate(term_limit = ifelse(str_detect(end_of_term, pattern = "retiring"), 1, term_limit)) %>%
  mutate(end_of_term = ifelse(str_detect(end_of_term, pattern = "term limit"),
                              str_sub(end_of_term, start = 1, end = str_length(end_of_term) - 14),
                              end_of_term)) %>%
  mutate(end_of_term = ifelse(str_detect(end_of_term, pattern = "retiring"),
                              str_sub(end_of_term, start = 1, end = str_length(end_of_term) - 11),
                              end_of_term)) %>%
  mutate(end_of_term = as.numeric(end_of_term)) %>%
  mutate(years_to_election = end_of_term - 2020) 
```
```{r}
# lockdown data again but this time including the dummies for state or local policy first

lockdowns <- 
read_excel('data/policy/Copy-of-Copy-of-Local-Policy-Responses-to-COVID-19.fin_ (1).xlsx',
           sheet = 'Local Policies') %>%
  # Get rid of city-specific policies
  filter(is.na(cityname)) %>%
  select(stfips, countyfips, stsipstart, stsipend, localsipstart, localsipend,
         dummysipstart, dummysipend, stbusclose, localbusclose, stbusopen, 
         localbusopen, dummybusclose, dummybusopen) %>%
  # Pick the earliest starts and the latest ends
  mutate(sipstart = ifelse(dummysipstart == 1, as_date(localsipstart), as_date(stsipstart)),
         sipend = ifelse(dummysipend == 1, as_date(localsipend), as_date(stsipend)),
         busclose = ifelse(dummybusclose == 1, as_date(localbusclose), as_date(stbusclose)),
         busopen = ifelse(dummybusopen == 1, as_date(localbusopen), as_date(stbusopen))) %>%
  select(stfips, countyfips, sipstart, sipend, busclose, busopen,
         dummysipstart, dummysipend, dummybusclose, dummybusopen) %>%
  mutate(across(c('sipstart', 'sipend', 'busclose', 'busopen'), as_date)) %>%
  mutate(stfips = str_pad(stfips, width = 2, side = "left", pad = "0"),
         countyfips = str_pad(countyfips, width = 3, side = "left", pad = "0"))
```

