---
title: "9_verification"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(texreg)
library(lfe)
library(janitor)
library(lubridate)
library(openintro)
library(readxl)
library(ggpubr)

```

```{r}
# Read in the household pulse file

hps <- read_csv(
'data/verification/Indicators_of_Anxiety_or_Depression_Based_on_Reported_Frequency_of_Symptoms_During_Last_7_Days.csv', col_types = cols()) %>% 
  clean_names() %>% 
  select(-confidence_interval, -quartile_range, -low_ci, -high_ci, -phase, -time_period,
         -time_period_label) %>% 
  mutate(time_period_start_date = mdy(time_period_start_date),
         time_period_end_date = mdy(time_period_end_date)) %>%  
  rename('start_date' = 'time_period_start_date',
         'end_date' = 'time_period_end_date') %>% 
  pivot_wider(names_from = indicator, values_from = value) %>%
  clean_names() %>% 
  rename('hps_depression' = 'symptoms_of_depressive_disorder',
         'hps_anxiety' = 'symptoms_of_anxiety_disorder',
         'hps_either' = 'symptoms_of_anxiety_disorder_or_depressive_disorder')

hps_state <- hps %>%
  filter(state != "United States") %>%
  select(-subgroup, -group) %>%
  mutate(state_2 = state2abbr(state)) %>%
  select(-state)

hps_merged_norm <- expand_grid(hps_state, state_searches_norm) %>%
  mutate(state_3 = str_sub(state, start = 4, end = 5)) %>%
  filter(state_3 == state_2, 
         date + days(6) >= start_date,
         date <= end_date) %>%
  select(-state_3) %>%
  rename('state_code' = 'state') %>%
  rename('state' = 'state_2')

hps_merged <- expand_grid(hps_state, state_searches_v1) %>%
  mutate(state_3 = str_sub(state, start = 4, end = 5)) %>%
  filter(state_3 == state_2, 
         date + days(6) >= start_date,
         date <= end_date) %>%
  select(-state_3) %>%
  rename('state_code' = 'state') %>%
  rename('state' = 'state_2')

hps_merged_2 <- hps_merged %>% 
  group_by(start_date, end_date, state, hps_depression, hps_anxiety) %>% 
  summarize(across(anxiety:average_3, mean)) %>%
  select(-average, -average_3)

hps_merged_norm_v2 <- hps_merged_norm_v1 %>% 
  group_by(start_date, end_date, state, hps_depression, hps_anxiety) %>% 
  summarize(across(anxiety:average_3, mean)) %>%
  rename('anxiety_norm' = 'anxiety',
         'depression_norm' = 'depression')

hps_all_v1 <- left_join(hps_merged_norm_v2, hps_merged_2)


  
```

```{r}
depression_norm <- hps_all_v1 %>% 
  ggplot(mapping = aes(x = hps_depression, y = depression_norm)) + 
    geom_point() + 
    theme_classic() + 
    labs(x = "% People Reporting Depression (HPS)",
         y = "Depression SVI (normalized)") + 
    geom_smooth(method = 'lm')

depression <- hps_all_v1 %>% 
  ggplot(mapping = aes(x = hps_depression, y = depression)) + 
    geom_point() + 
    theme_classic() + 
    labs(x = "% People Reporting Depression (HPS)",
         y = "Depression SVI (un-normalized)") + 
    geom_smooth(method = 'lm')

depression_norm_log <- hps_all_v1 %>%
  ggplot(mapping = aes(x = log(hps_depression), y = log(depression_norm+1))) + 
    geom_point() + 
    theme_classic() + 
    labs(x = "Log % People Reporting Depression (HPS)",
         y = "Log Depression SVI (normalized)") + 
    geom_smooth(method = 'lm')

depression_log <- hps_all_v1 %>% 
  ggplot(mapping = aes(x = log(hps_depression), y = log(depression+1))) + 
    geom_point() + 
    theme_classic() + 
    labs(x = "Log % People Reporting Depression (HPS)",
         y = "Log Depression SVI (un-normalized)") + 
    geom_smooth(method = 'lm')

depression_total <- ggarrange(depression_norm, depression, depression_norm_log, depression_log, 
          labels = c("Normalized", "Un-Normalized", "Log Normalized", 
                     "Log Un-Normalized"), nrow = 1)

ggsave(depression_total, file = "depression_total.png", width = 10, height = 3,
       units = "in")

```

```{r}

test <- felm(depression_norm ~ hps_depression|state|0|state, data = hps_all_v1)

test2 <- felm(depression ~ hps_depression|state|0|state, data = hps_all_v1)

test3 <- felm(log(depression_norm+1) ~ log(hps_depression+1)|state|0|state, data = hps_all_v1)

test4 <- felm(log(depression + 1) ~ log(hps_depression + 1)|state|0|state, data = hps_all_v1)

htmlreg(l = list(test, test2, test3, test4), include.ci = FALSE, digits = 4, file = "depression_verif.doc")
```
```{r}
anxiety_norm <- hps_all_v1 %>% 
  filter(state == "NY") %>% 
  ggplot(mapping = aes(x = hps_anxiety, y = anxiety_norm)) + 
    geom_point() + 
    theme_classic() + 
    labs(x = "% People Reporting Anxiety (HPS)",
         y = "Anxiety SVI (normalized)") + 
    geom_smooth(method = 'lm')

anxiety <- hps_all_v1 %>% 
  ggplot(mapping = aes(x = hps_anxiety, y = anxiety)) + 
    geom_point() + 
    theme_classic() + 
    labs(x = "% People Reporting Anxiety (HPS)",
         y = "Anxiety SVI (Un-normalized)") + 
    geom_smooth(method = 'lm')

anxiety_norm_log <- hps_all_v1 %>% 
  ggplot(mapping = aes(x = log(hps_anxiety), y = log(anxiety_norm+1))) + 
    geom_point() + 
    theme_classic() + 
    labs(x = "% People Reporting Anxiety (HPS)",
         y = "Anxiety SVI (normalized)") + 
    geom_smooth(method = 'lm')

anxiety_log <- hps_all_v1 %>% 
  ggplot(mapping = aes(x = log(hps_anxiety), y = log(anxiety+1))) + 
    geom_point() + 
    theme_classic() + 
    labs(x = "% People Reporting Anxiety (HPS)",
         y = "Anxiety SVI (un-normalized)") + 
    geom_smooth(method = 'lm')

anxiety_total <- ggarrange(anxiety_norm, anxiety, anxiety_norm_log, anxiety_log, 
          labels = c("Normalized", "Un-Normalized", "Log Normalized", 
                     "Log Un-Normalized"), nrow = 1)

ggsave(anxiety_total, file = "anxiety_total_2.png", width = 10, height = 3,
       units = "in")

```

```{r}

test <- felm(anxiety_norm ~ hps_anxiety|state|0|state, data = hps_all_v1)

test2 <- felm(anxiety ~ hps_anxiety|state|0|state, data = hps_all_v1)

test3 <- felm(log(anxiety_norm+1) ~ log(hps_anxiety+1)|state|0|state, data = hps_all_v1)

test4 <- felm(log(anxiety + 1) ~ log(hps_anxiety + 1)|state|0|state, data = hps_all_v1)

htmlreg(l = list(test, test2, test3, test4), include.ci = FALSE, digits = 4, file = "anxiety_verif.doc")

```


```{r}
# alc 

alc <- read_excel('data/verification/state_alcsales_December2020.xlsx', sheet = "Data") %>%
  clean_names() %>% 
  select(-gallons, -ethanol, -population, -per_capita3yr, -pct_change) %>% 
  pivot_wider(names_from = 'beverage', values_from = 'per_capita') %>% 
  rename('spirits' = `1`,
         'wine' = `2`,
         'beer' = `3`,
         'all_alc' = `4`)

# read in alcohol norm

alc_2 <- left_join(alc, alcohol_norm, by = c("year", "month", "fips"))

```
```{r}
# LOOK AT THIS ... GRAPH

eq <- function(x,y) {
  m <- lm(y ~ x)
  as.character(
    as.expression(
      substitute(italic(y) == a + b %.% italic(x)*","~~italic(r)^2~"="~r2,
                list(a = format(coef(m)[1], digits = 4),
                b = format(coef(m)[2], digits = 4),
                r2 = format(summary(m)$r.squared, digits = 3)))
    )
  )
}

alcohol_norm_graph <- alc_2 %>%
  ggplot(mapping = aes(x = log(all_alc+1), y = log(alcohol_norm+1))) + 
    geom_point() +
    theme_classic() + 
    labs(x = "Log Per-capita monthly alcohol consumption (gal)",
         y = "Log Adjusted Alcohol SVI (normalized vs. anchor)") + 
    geom_smooth(method='lm')

alcohol_graph <- alc_2 %>%
   ggplot(mapping = aes(x = log(all_alc + 1), y = log(alcohol + 1))) + 
    geom_point() +
    theme_classic() + 
    labs(x = "Log Per-capita monthly alcohol consumption (gal)",
         y = "Log Alcohol SVI (un-normalized)") + 
    geom_smooth(method='lm')
```

```{r}
# Test some regressions

test <- felm(alcohol_norm ~ all_alc|state|0|state, data = alc_2)

test2 <- felm(alcohol ~ all_alc|state|0|state, data = alc_2)

test3 <- felm(log(alcohol_norm) ~ log(all_alc)|state|0|state, data = alc_2)


test4 <- felm(log(alcohol) ~ log(all_alc)|state|0|state, data = alc_2)

```

```{r}
# Tobacco?

tax_rev <- read_excel('data/verification/selected-monthly-sales-tax-collections-data.xlsx') %>%
  clean_names() %>%
  filter(tax_type == "Tobacco") %>% 
  select(-collection_month, -tax_type) %>%
  rename('state' = 'name',
         'month' = 'numeric_month') %>% 
  mutate(state = state2abbr(state)) %>%
  mutate(date = as_date(paste(year, month, '01', sep = "-")))

cig_tax <- read_csv('data/verification/Table_6694.csv') %>% 
  clean_names() %>% 
  filter(year %in% c(2019, 2020, 2021)) %>% 
  select(-data_source, -topic_description, -measure_description,
         -provision_group_description, -provision, -citation, -enacted_date,
         -effective_date, -comments) %>%
  mutate(state_2 = state2abbr(location_description)) %>% 
  select(-location_description) %>%
  mutate(start_date = 
           ifelse(quarter == 1, as_date(paste(year, "01-01", sep = "-")),
                  ifelse(quarter == 2, as_date(paste(year, "04-01", sep = "-")),
                         ifelse(quarter == 3, as_date(paste(year, "07-01")),
                                as_date(paste(year, "10-01", sep = "-"))))),
         end_date = 
           ifelse(quarter == 1, as_date(paste(year, "03-31", sep = "-")),
                           ifelse(quarter == 2, as_date(paste(year, "06-30", sep = "-")),
                                  ifelse(quarter == 3, as_date(paste(year, "09-30", sep = "-")),
                                         as_date(paste(year, "12-31", sep = "-")))))) %>% 
  mutate(start_date = as_date(start_date),
         end_date = as_date(end_date)) %>% 
  select(-quarter, -year)

cigs_combined <- expand_grid(tax_rev, cig_tax) %>% 
  filter(state == state_2,
         date >= start_date,
         date <= end_date) %>%
  select(-state_2, -start_date, -end_date) %>% 
  mutate(amount = as.numeric(amount)) %>% 
  mutate(packs_mil = amount/(value * 1000000))

# combine in the search data

smoking_state <- readRDS('smoking_state.rds')
  
  
```

