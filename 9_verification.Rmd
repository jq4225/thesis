---
title: "9_verification"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(texreg)
library(lfe)
library(janitor)
library(lubridate)
library(openintro)
library(readxl)

```

```{r}
# Read in the household pulse file

hps <- read_csv(
'data/verification/Indicators_of_Anxiety_or_Depression_Based_on_Reported_Frequency_of_Symptoms_During_Last_7_Days.csv', col_types = cols()) %>% 
  clean_names() %>% 
  select(-confidence_interval, -quartile_range, -low_ci, -high_ci, -phase, -time_period,
         -time_period_label) %>% 
  mutate(time_period_start_date = mdy(time_period_start_date),
         time_period_end_date = mdy(time_period_end_date)) %>%  
  rename('start_date' = 'time_period_start_date',
         'end_date' = 'time_period_end_date') %>% 
  pivot_wider(names_from = indicator, values_from = value) %>%
  clean_names() %>% 
  rename('hps_depression' = 'symptoms_of_depressive_disorder',
         'hps_anxiety' = 'symptoms_of_anxiety_disorder',
         'hps_either' = 'symptoms_of_anxiety_disorder_or_depressive_disorder')

hps_state <- hps %>%
  filter(state != "United States") %>%
  select(-subgroup, -group) %>%
  mutate(state_2 = state2abbr(state)) %>%
  select(-state)

hps_merged_norm <- expand_grid(hps_state, state_searches_norm) %>%
  mutate(state_3 = str_sub(state, start = 4, end = 5)) %>%
  filter(state_3 == state_2, 
         date + days(6) >= start_date,
         date <= end_date) %>%
  select(-state_3) %>%
  rename('state_code' = 'state') %>%
  rename('state' = 'state_2')

hps_merged <- expand_grid(hps_state, state_searches_v1) %>%
  mutate(state_3 = str_sub(state, start = 4, end = 5)) %>%
  filter(state_3 == state_2, 
         date + days(6) >= start_date,
         date <= end_date) %>%
  select(-state_3) %>%
  rename('state_code' = 'state') %>%
  rename('state' = 'state_2')

hps_merged_2 <- hps_merged %>% 
  group_by(start_date, end_date, state, hps_depression, hps_anxiety) %>% 
  summarize(across(anxiety:average_3, mean))

hps_merged_norm_v2 <- hps_merged_norm_v1 %>% 
  group_by(start_date, end_date, state, hps_depression, hps_anxiety) %>% 
  summarize(across(anxiety:average_3, mean))  


  
```
```{r}
test <- felm(log(depression+1) ~ log(hps_depression+1)|state|0|state, data = hps_merged_norm_v2)

test2 <- felm(log(depression + 1) ~ log(hps_depression + 1)|state|0|state, data = hps_merged_2)
```
```{r}
# alc 

alc <- read_excel('data/verification/state_alcsales_December2020.xlsx', sheet = "Data") %>%
  clean_names() %>% 
  select(-gallons, -ethanol, -population, -per_capita3yr, -pct_change) %>% 
  pivot_wider(names_from = 'beverage', values_from = 'per_capita') %>% 
  rename('spirits' = `1`,
         'wine' = `2`,
         'beer' = `3`,
         'all_alc' = `4`)

# read in alcohol norm

alc_2 <- left_join(alc, alcohol_norm, by = c("year", "month", "fips"))

```

```{r}
# Test some regressions

test <- felm(log(all_alc) ~ log(alcohol)|state|0|state, data = alc_2)
```

