---
title: "2_google"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(janitor)
library(gtrendsR)
library(readxl)

dma_codes <- read_csv('dma_codes.csv', col_types = cols()) %>%
  select(google_code) %>%
  mutate(google_code = ifelse(google_code == "US-D)-511",
                              "US-DC-511", google_code)) %>%
  distinct()

dma_codes <- pull(dma_codes, google_code)

dma_codes <- sort(dma_codes)
```

Search terms: (don't use anymore -- look at the google doc)

Depression: 640
Anxiety and Stress: 639
Mental Health: 437

Headaches & Migraines: 631
Sleep Disorders: 633

Movies: 34
Comics & Animation: 316
Books & Literature: 22
Music & Audio: 35
Online Media: 613
TV & Video: 36
Games: 8

Substance Abuse: 257
Subcats:
- Drug & Alcohol Treatment: 1350
- Smoking & Smoking Cessation: 1237

Alcoholic Beverages: 277
Tobacco Products: 123

```{r setup}
# Don't need to run this -- this is replication code from the junior paper, I
# have the results already

data(countries)

us_codes <- countries %>%
  filter(country_code == "US") %>%
  slice(20267:20476) %>%
  mutate(name = tolower(name)) %>%
  select(-country_code) %>%
  clean_names()

google_crosswalk <- read_csv('data/GoogleTrends_CountyDMA_Mapping.csv') %>%
  clean_names() %>%
  mutate(google_dma = tolower(google_dma))

dma_codes <- left_join(google_crosswalk, us_codes, by = c("google_dma" = "name"))

dma_codes_csv <- dma_codes %>%
  drop_na(sub_code) %>%
  mutate(state_dma = str_sub(google_dma, start = str_length(google_dma) - 1),
         dma_code = str_sub(sub_code, start = str_length(sub_code) - 2)) %>%
  mutate(google_code = str_c("US", state_dma, dma_code, sep = "-")) %>%
  mutate(google_code = toupper(google_code))
```

```{r}
# START HERE

dma_codes <- read_csv('dma_codes.csv', col_types = cols()) %>%
  select(google_code) %>%
  mutate(google_code = ifelse(google_code == "US-D)-511",
                              "US-DC-511", google_code)) %>%
  distinct()

dma_codes <- pull(dma_codes, google_code)

dma_codes <- sort(dma_codes)
```

```{r}
# And start reading in data here -- this is for individual search terms
# Sadness here
search_term <- '/m/03x69g'

mental_health <- tibble()

```


```{r}
# Run this

for(i in 22:54) {
  
  if(i < 53) {
    # Exception case for when we need to search twice for NY
    if(i != 32) {
       temp <- gtrends(keyword = search_term, geo = c('US-NY-501', dma_codes[(i-1)*4 + 1],
                                                 dma_codes[(i-1)*4 + 2],
                                                 dma_codes[(i-1)*4 + 3],
                                                 dma_codes[(i-1)*4 + 4]),
                            time = '2016-01-01 2020-12-31', 
                         onlyInterest = TRUE)$interest_over_time
       
       temp <- temp %>% 
          mutate(hits = ifelse(hits == "<1", "0.5", hits)) %>%
          mutate(hits = as.numeric(hits)) %>%
         pivot_wider(id_cols = date, names_from = geo,
                                    values_from = hits) %>%
                        mutate_at(vars(3:6), ~ . * max(.)/max(`US-NY-501`))
    }
    else {
      temp <- gtrends(keyword = search_term, geo = c('US-NY-501', dma_codes[(i-1)*4 + 1],
                                                 dma_codes[(i-1)*4 + 2],
                                                 dma_codes[(i-1)*4 + 3],
                                                 dma_codes[(i-1)*4 + 4]),
                            time = '2016-01-01 2020-12-31', 
                         onlyInterest = TRUE)$interest_over_time %>%
        distinct() %>%
        mutate(hits = ifelse(hits == "<1", "0.5", hits)) %>%
        mutate(hits = as.numeric(hits)) %>%
        pivot_wider(id_cols = date, names_from = geo,
                values_from = hits) %>%
        mutate_at(vars(3:5), ~ . * max(.)/max(`US-NY-501`))
    }
   
  }
  
  else if(i == 53) {
    temp <- gtrends(keyword = search_term, geo = c('US-NY-501', dma_codes[(i-1)*4 + 1]),
                            time = '2016-01-01 2020-12-31', 
                         onlyInterest = TRUE)$interest_over_time %>%
      mutate(hits = ifelse(hits == "<1", "0.5", hits)) %>%
      mutate(hits = as.numeric(hits)) %>%
      pivot_wider(id_cols = date, names_from = geo,
                values_from = hits) %>%
      mutate_at(vars(3), ~ . * max(.)/max(`US-NY-501`))
  }
  
  else{
    temp <- gtrends(keyword = search_term, geo = c('US-NY-501'),
                            time = '2016-01-01 2020-12-31', 
                         onlyInterest = TRUE)$interest_over_time %>%
      mutate(hits = ifelse(hits == "<1", "0.5", hits)) %>%
      mutate(hits = as.numeric(hits)) %>%
      pivot_wider(id_cols = date, names_from = geo,
                  values_from = hits) %>%
      rename(`US-NY-501-FINAL` = `US-NY-501`)
  }
  
  if(i == 1) {
    mental_health <- temp
  }
  else {
    mental_health <- cbind(mental_health, temp)
  }
  Sys.sleep(3)
  
  print(i)
}

mental_health_clean <- mental_health[, -which(duplicated(names(mental_health)))] %>%
  select(-`US-NY-501`) %>%
  rename(`US-NY-501` = `US-NY-501-FINAL`) %>% 
  pivot_longer(cols = `US-AK-743`:`US-NY-501`,
               names_to = "dma", values_to = "mental_health")

saveRDS(mental_health_clean, file = "mental_health_scaled.rds")
```

```{r}
# Pivot longer really quickly

exercise_long <- exercise_clean %>%
  pivot_longer(cols = `US-AK-743`:`US-NY-501`,
               names_to = "dma", values_to = "exercise")

saveRDS(exercise_long, file = "exercise_scaled.rds")


```

```{r}
# Getting the week beginning dates -- each date is the BEGINNING of the week

week_begin <- sadness_clean %>%
  select(date)

```

```{r}
# And this is for categories

category <- '639'

depression <- tibble()
```


```{r}
# Run this

for(i in 1:54) {
  
  if(i < 53) {
    temp <- gtrends(cat = category, geo = c('US-NY-501', dma_codes[(i-1)*4 + 1],
                                                 dma_codes[(i-1)*4 + 2],
                                                 dma_codes[(i-1)*4 + 3],
                                                 dma_codes[(i-1)*4 + 4]),
                            time = '2016-01-01 2020-12-31', 
                         onlyInterest = TRUE)$interest_over_time %>%
    mutate(hits = ifelse(hits == "<1", "0.5", hits)) %>%
    mutate(hits = as.numeric(hits)) %>%
    pivot_wider(id_cols = date, names_from = geo,
                values_from = hits) %>%
    mutate_at(vars(3:6), ~ . * max(.)/max(`US-NY-501`))
  }
  
  else if(i == 53) {
    temp <- gtrends(cat = category, geo = c('US-NY-501', dma_codes[(i-1)*4 + 1]),
                            time = '2016-01-01 2020-12-31', 
                         onlyInterest = TRUE)$interest_over_time %>%
    mutate(hits = ifelse(hits == "<1", "0.5", hits)) %>%
    mutate(hits = as.numeric(hits)) %>%
    pivot_wider(id_cols = date, names_from = geo,
                values_from = hits) %>%
    mutate_at(vars(3), ~ . * max(.)/max(`US-NY-501`))
  }
  
  else{
    temp <- gtrends(cat = category, geo = c('US-NY-501'),
                            time = '2016-01-01 2020-12-31', 
                         onlyInterest = TRUE)$interest_over_time %>%
      mutate(hits = ifelse(hits == "<1", "0.5", hits)) %>%
      mutate(hits = as.numeric(hits)) %>%
      pivot_wider(id_cols = date, names_from = geo,
                  values_from = hits) %>%
      rename(`US-NY-501-FINAL` = `US-NY-501`)
  }
  
  if(i == 1) {
    depression <- temp
  }
  else {
    depression <- cbind(depression, temp)
  }
  Sys.sleep(3)
  
  print(i)
}

depression_clean <- depression[, -which(duplicated(names(depression)))] %>%
  select(-`US-NY-501`) %>%
  rename(`US-NY-501` = `US-NY-501-FINAL`)

saveRDS(depression_clean, file = "depression_scaled.rds")
```
```{r}
# For only one DMA at a time ... 

for(i in 1:209) {
  temp <- gtrends(cat = category, geo = dma_codes[i],
                            time = '2016-01-01 2020-12-31', 
                         onlyInterest = TRUE)$interest_over_time %>%
                pivot_wider(id_cols = date, names_from = geo,
                values_from = hits)
  
  if(i == 1) {
    depression <- temp
  }
  else {
    temp <- temp %>%
        select(-date)
    
    depression <- cbind(depression, temp)
  }
  Sys.sleep(3)
  
  print(i)
}

# depression_clean <- depression[, -which(duplicated(names(depression)))] %>%
#   select(-`US-NY-501`) %>%
#   rename(`US-NY-501` = `US-NY-501-FINAL`)
```

```{r}
# Internet user data by DMA

dma_codes <- read_csv('dma_codes.csv') %>%
  select(google_code, statefp, cntyfp) %>%
  mutate(statefp = str_pad(statefp, width = 2, side = "left", pad = "0"),
         cntyfp = str_pad(cntyfp, width = 3, side = "left", pad = 0)) %>%
  mutate(fips = str_c(statefp, cntyfp, sep = "")) %>%
  select(google_code, fips)

# internet <- read_excel("data/county_stats/county_connections_dec_2018.xlsx",
#                        sheet = "County Connections Dec 2018") %>%
#   mutate_at(c("consumer", "non_consumer", "all", "ratio"),
#             ~ ifelse(. == -9999, 0, .))

internet <- read_excel("data/county_stats/broadband_long2000-2018rev.xlsx") %>%
  filter(year == 2018) %>%
  select(id, broadband, cfips) %>%
  mutate(cfips = str_pad(cfips, width = 5, side = "left", pad = "0"))

# match with population

population <- read_csv("data/county_stats/pop_race.csv", skip = 1) %>%
  clean_names() %>%
  select(id, estimate_sex_and_age_total_population, 
         estimate_sex_and_age_total_population_5_to_9_years,
         estimate_sex_and_age_total_population_5_to_9_years,
         estimate_sex_and_age_total_population_10_to_14_years) %>%
  mutate(adult_pop = estimate_sex_and_age_total_population - 
           estimate_sex_and_age_total_population_5_to_9_years - 
           estimate_sex_and_age_total_population_10_to_14_years) %>%
  select(id, adult_pop)

internet_users <- left_join(internet, population, by = "id") %>%
  drop_na(adult_pop) %>%
  mutate(internet_users = broadband * adult_pop / 1000) %>%
  select(cfips, internet_users)

# Match with DMA

dma_internet <- left_join(internet_users, dma_codes, by = c("cfips" = "fips")) %>%
  drop_na(google_code) %>%
  select(-cfips) %>%
  group_by(google_code) %>%
  summarize(internet_users = sum(internet_users))
  

  
```

```{r}
# Reading in our anchor index

anchor <- read_excel('anchor_index.xlsx')

anchor_list <- c(anchor$Code)
```


```{r}
# Googling our anchor index
# anchor_index <- tibble()

for(j in 44:length(anchor_list)) {
  
  keyword <- tibble()
  
  for(i in 1:54) {
  
    if(i < 53) {
      # Exception case for when we need to search twice for NY
      if(i != 32) {
         temp <- gtrends(keyword = anchor_list[j], geo = c('US-NY-501', dma_codes[(i-1)*4 + 1],
                                                   dma_codes[(i-1)*4 + 2],
                                                   dma_codes[(i-1)*4 + 3],
                                                   dma_codes[(i-1)*4 + 4]),
                              time = '2016-01-01 2020-12-31', 
                           onlyInterest = TRUE)$interest_over_time
         
         temp <- temp %>% 
           mutate(hits = ifelse(hits == "<1", "0.5", hits)) %>%
           mutate(hits = as.numeric(hits)) %>%
           pivot_wider(id_cols = date, names_from = geo,
                                      values_from = hits) %>%
            mutate_at(vars(3:6), ~ . * max(.)/max(`US-NY-501`))
      }
      else {
        temp <- gtrends(keyword = anchor_list[j], geo = c('US-NY-501', dma_codes[(i-1)*4 + 1],
                                                   dma_codes[(i-1)*4 + 2],
                                                   dma_codes[(i-1)*4 + 3],
                                                   dma_codes[(i-1)*4 + 4]),
                              time = '2016-01-01 2020-12-31', 
                           onlyInterest = TRUE)$interest_over_time %>%
          distinct() %>%
          mutate(hits = ifelse(hits == "<1", "0.5", hits)) %>%
          mutate(hits = as.numeric(hits)) %>%
          pivot_wider(id_cols = date, names_from = geo,
                  values_from = hits) %>%
          mutate_at(vars(3:5), ~ . * max(.)/max(`US-NY-501`))
      }
     
    }
    
    else if(i == 53) {
      temp <- gtrends(keyword = anchor_list[j], geo = c('US-NY-501', dma_codes[(i-1)*4 + 1]),
                              time = '2016-01-01 2020-12-31', 
                           onlyInterest = TRUE)$interest_over_time %>%
      mutate(hits = ifelse(hits == "<1", "0.5", hits)) %>%
          mutate(hits = as.numeric(hits)) %>%
      pivot_wider(id_cols = date, names_from = geo,
                  values_from = hits) %>%
      mutate_at(vars(3), ~ . * max(.)/max(`US-NY-501`))
    }
    
    else {
      temp <- gtrends(keyword = anchor_list[j], geo = c('US-NY-501'),
                              time = '2016-01-01 2020-12-31', 
                           onlyInterest = TRUE)$interest_over_time %>%
        mutate(hits = ifelse(hits == "<1", "0.5", hits)) %>%
        mutate(hits = as.numeric(hits)) %>%
        pivot_wider(id_cols = date, names_from = geo,
                    values_from = hits) %>%
        rename(`US-NY-501-FINAL` = `US-NY-501`)
    }
    
    if(i == 1) {
      keyword <- temp
    }
    else {
      keyword <- cbind(keyword, temp)
    }
    Sys.sleep(3)
    
    # print(i)
  }

  keyword_clean <- keyword[, -which(duplicated(names(keyword)))] %>%
    select(-`US-NY-501`) %>%
    rename(`US-NY-501` = `US-NY-501-FINAL`) %>%
    pivot_longer(cols = `US-AK-743`:`US-NY-501`,
                 names_to = "dma", values_to = anchor[[j,2]])
  
  if(j == 1) {
    anchor_index <- keyword_clean
  }
  
  else {
    anchor_index <- left_join(anchor_index, keyword_clean, by = c("dma", "date"))
  }
  
  print(j)
  
  Sys.sleep(30)

}

anchor_index_2 <- anchor_index %>%
  clean_names()


```
```{r}
# Rolling average

anchor_index <- anchor_index_2 %>%
  mutate(across(c(`honey`:`japan`), ~ . * 100 /max(.))) %>%
  rowwise() %>%
  mutate(average = mean(c_across(`honey`:`japan`))) %>%
  ungroup() %>%
  group_by(dma) %>%
  arrange(date) %>%
  mutate(average_3 = rollmean(average, k = 3, fill = "extend"))

searches_v9 <- left_join(searches_v8, 
                         anchor_index %>% mutate(date = as_date(date)) %>% 
                                                   select(date, dma, average, average_3), 
                         by = c("dma", "date")) 



searches_norm3 <- searches_v9 %>%
  mutate(across(c(`alcohol`:`worry`, depression), ~ ./average_3)) %>%
  # renormalize everything to 100 %>%
  mutate(across(c(`alcohol`:`worry`, depression), ~ . * 100 / max(.)))

```
```{r}
# Redoing average excluding the terms w/ more than 15% of zeroes

# zero_percent_anchor <- anchor_index %>%
#   group_by(dma) %>%
#   select(dma, `honey`:`japan`) %>% 
#   summarize(across(.cols = c(`honey`:`japan`), ~ sum(.==0)),
#             weeks = n()) %>%
#   mutate(across(.cols = c(`honey`:`japan`), ~ . * 100 / weeks))
# 
# zero_summary_anchor <- zero_percent_anchor %>%
#   summarize(across(.cols = `honey`:`japan`, mean)) %>%
#   pivot_longer(cols = `honey`:`japan`, names_to = "term", values_to= "zero_percent")

anchor_index_2 <- anchor_index %>%
  select(-elevator, -cereal, -waste, -recycling, -debit_card, -soft_drinks, -french_fries,
         -grain, -currency) %>%
  mutate(across(c(`honey`:`japan`), ~ . * 100 /max(.))) %>%
  rowwise() %>%
  mutate(average = mean(c_across(`honey`:`japan`))) %>%
  ungroup() %>%
  group_by(dma) %>%
  arrange(date) %>%
  mutate(average_3 = rollmean(average, k = 3, fill = "extend"))

searches_norm3_v3 <- left_join(searches_v10 %>% select(-average, -average_3), 
                         anchor_index_2 %>% mutate(date = as_date(date)) %>% 
                                                   select(date, dma, average, average_3), 
                         by = c("dma", "date")) %>% 
  mutate(across(c(`alcohol`:`worry`, depression), ~ ./average_3)) %>%
  # renormalize everything to 100
  mutate(across(c(`alcohol`:`worry`, depression), ~ . * 100 / max(.)))

```

```{r}
# Merge in new search terms that we're interested in

new_search <- cannabis_scaled %>%
  left_join(., cigarette_scaled, by = c("dma", "date")) %>%
  left_join(., drug_scaled, by = c("dma", "date")) %>% 
  left_join(., e_cig_scaled, by = c("dma", "date")) %>% 
  left_join(., exercise_scaled, by = c("dma", "date")) %>% 
  left_join(., lonely_scaled, by = c("dma", "date")) %>% 
  left_join(., sleep_scaled, by = c("dma", "date")) %>% 
  left_join(., stress_scaled, by = c("dma", "date")) %>% 
  left_join(., yoga_scaled, by = c("dma", "date"))

searches_norm3_v4 <- searches_norm3_v3 %>%
  select(-loneliness, -stress) %>%
  left_join(., new_search, by = c("dma", "date")) %>%
  mutate(across(`cigarette`:`yoga`, ~ ./average_3)) %>%
  mutate(across(`cigarette`:`yoga`, ~ . * 100 / max(.)))

searches_v11 <- searches_v10 %>%
  select(-loneliness, -stress) %>%
  left_join(., new_search, by = c("dma", "date"))

# Joining in mental health searches

searches_norm3_v5 <- searches_norm3_v4 %>%
  left_join(., mental_health_clean, by = c("dma", "date")) %>%
  mutate(mental_health =  mental_health /average_3) %>%
  mutate(mental_health = mental_health * 100 / max(mental_health))

searches_v12 <- searches_v11 %>%
  left_join(., mental_health_clean, by = c("dma", "date"))
```

