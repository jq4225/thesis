---
title: "11_pretrends"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lfe)
library(texreg)
library(zoo)

searches_norm3_v20_5 <- readRDS('clean_data/search/searches_norm3_v20_5.rds')
```

```{r}

searches_norm3_v22 <- searches_norm3_v21 %>%
  mutate(across(c(busclose_first_counter, busopen_most_pop_counter, 
                  sip_first_counter, no_sip_most_pop_counter), ~ relevel(factor(.), ref = "0")))

searches_norm3_v22_5 <- searches_norm3_v22 %>%
  filter(dma %in% dma_5)

anxiety_bus <- felm(I(log(anxiety + 1 )) ~  
                 busclose_first_counter * year_indicator + 
                busopen_most_pop_counter * year_indicator + 
                        online_only * year_indicator + 
                        hybrid * year_indicator + 
                        other * year_indicator + 
                        cases_per_100k + unemploy_rate + temp + precip + 
                       log(lockdown + 1) + log(covid + 1) + 
                       factor(income_support) + factor(debt_contract_relief)
                       |factor(week) + factor(dma) + factor(year)|0|dma, 
              weights = na.omit(searches_norm3_v22_5$pop),
                  data = searches_norm3_v22_5 %>% filter(is.na(pop) == FALSE))

# Reason traditional DiD works better is b/c data fluctuation?
```

```{r}
# Pre-trends graph

searches_norm3_v20_5 %>% 
  mutate(anxiety_index = 0.924 * anxiety + 0.213 * nervous + 
                            0.133 * stress + 0.198 * worry + 0.211 * panic,
         depression_index = 0.485 * crying + 0.782 * depression + 
                                0.127 * lonely + 0.320 * sad + 0.184 * tired) %>% 
  select(week, year_indicator, year, depression, depression_index, anxiety, anxiety_index, pop) %>% 
  rename("Depression" = "depression",
         "Anxiety" = "anxiety",
         "Depression Index" = "depression_index",
         "Anxiety Index" = "anxiety_index") %>% 
  pivot_longer(cols = `Depression`:`Anxiety Index`, names_to = "term", values_to = "svi") %>% 
  drop_na(pop) %>% 
  group_by(week, year_indicator, term) %>% 
  summarize(svi = weighted.mean(svi, pop), .groups = "drop") %>%
  # group_by(year_indicator, term) %>% 
  # arrange(week) %>% 
  mutate(svi = rollmean(svi, k = 3, fill = "extend")) %>% 
  ggplot(aes(x = week, y = svi, color = factor(year_indicator))) +
    geom_line() + 
    # xlim(0, 20) + 
    scale_color_discrete(name = "Year", labels = c("2016-2019", "2020")) + 
    facet_wrap(~term, scales = "free") + 
    theme_classic() + 
   theme(legend.position = "top") + 
   labs(y = "Population-weighted SVI (3-week moving avg.)",
        x = "Week of Year")

# SIP start
searches_norm3_v21_5 %>% 
  mutate(anxiety_index = 0.924 * anxiety + 0.213 * nervous + 
                            0.133 * stress + 0.198 * worry + 0.211 * panic,
         depression_index = 0.485 * crying + 0.782 * depression + 
                                0.127 * lonely + 0.320 * sad + 0.184 * tired) %>% 
  select(sip_first_counter, 
         year_indicator, year, depression, depression_index, anxiety, anxiety_index, pop) %>% 
  rename("Depression" = "depression",
         "Anxiety" = "anxiety",
         "Depression Index" = "depression_index",
         "Anxiety Index" = "anxiety_index") %>% 
  pivot_longer(cols = `Depression`:`Anxiety Index`, names_to = "term", values_to = "svi") %>% 
  drop_na(pop) %>% 
  group_by(sip_first_counter, year_indicator, term) %>% 
  summarize(svi = weighted.mean(svi, pop), .groups = "drop") %>%
  # group_by(year_indicator, term) %>% 
  # arrange(week) %>% 
  mutate(svi = rollmean(svi, k = 3, fill = 'extend')) %>% 
  ggplot(aes(x = sip_first_counter, y = svi, color = factor(year_indicator))) +
    geom_line() + 
    # xlim(0, 20) + 
    scale_color_discrete(name = "Year", labels = c("2016-2019", "2020")) + 
    facet_wrap(~term, scales = "free") + 
    theme_classic() + 
   theme(legend.position = "top") + 
   labs(y = "Population-weighted SVI (3-week moving avg.)",
        x = "Weeks from SIP start")

# SIP end
searches_norm3_v21_5 %>% 
  mutate(anxiety_index = 0.924 * anxiety + 0.213 * nervous + 
                            0.133 * stress + 0.198 * worry + 0.211 * panic,
         depression_index = 0.485 * crying + 0.782 * depression + 
                                0.127 * lonely + 0.320 * sad + 0.184 * tired) %>% 
  select(no_sip_most_pop_counter, 
         year_indicator, year, depression, depression_index, anxiety, anxiety_index, pop) %>% 
  rename("Depression" = "depression",
         "Anxiety" = "anxiety",
         "Depression Index" = "depression_index",
         "Anxiety Index" = "anxiety_index") %>% 
  pivot_longer(cols = `Depression`:`Anxiety Index`, names_to = "term", values_to = "svi") %>% 
  drop_na(pop) %>% 
  group_by(no_sip_most_pop_counter, year_indicator, term) %>% 
  summarize(svi = weighted.mean(svi, pop), .groups = "drop") %>%
  # group_by(year_indicator, term) %>% 
  # arrange(week) %>% 
  mutate(svi = rollmean(svi, k = 3, fill = 'extend')) %>% 
  ggplot(aes(x = no_sip_most_pop_counter, y = svi, color = factor(year_indicator))) +
    geom_line() + 
    # xlim(0, 20) + 
    scale_color_discrete(name = "Year", labels = c("2016-2019", "2020")) + 
    facet_wrap(~term, scales = "free") + 
    theme_classic() + 
   theme(legend.position = "top") + 
   labs(y = "Population-weighted SVI (3-week moving avg.)",
        x = "Weeks from SIP end")
```

```{r}
# State pretrends



depression_1 <- felm(log(hps_depression) ~ factor(c2_workplace_closing)  +
               initclaims_combined + 
               contclaims_combined + cases_per_100k_5day + 
               factor(e1_income_support) + factor(e2_debt_contract_relief) + 
                log(covid_norm+1) + log(lockdown_norm+1)
             |factor(period) + factor(state) + factor(year)|0|state,
             data = hps_all_v11 %>% drop_na(pop),
             weights = na.omit(hps_all_v11$pop))
```

