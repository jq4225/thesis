---
title: "1_notgoogle"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(janitor)
library(readxl)
library(lubridate)
library(stringr)
```

```{r making employment impact by county!}
# cleaning the industry data
employ_dirty <- read_csv('data/county_stats/cbp2019.csv', show_col_types = FALSE) %>%
  mutate(fipstate = as.character(fipstate),
         fipscty = as.character(fipscty)) %>%
  mutate(fipstate = str_pad(fipstate, width = 2, side = "left", pad = "0"),
         fipscty = str_pad(fipscty, width = 3, side = "left", pad = "0")) %>%
  
  # cleaning up the naics codes
  mutate(naics = gsub('------', 'all', naics)) %>%
  mutate(naics = gsub('/', '', naics)) %>%
  mutate(naics = gsub('-', '', naics)) %>%
  select(fipstate, fipscty, naics, emp) %>%
  filter(naics == "all" | str_length(naics) == 3)

propensity <- read_csv('data/county_stats/pone.0239113.s001.csv') %>%
  select(industry_code, affected_share) %>%
  mutate(affected_share = affected_share/100) %>%
  mutate(industry_code = as.character(industry_code))

#matching propensity scores

employ_propensity <- left_join(employ_dirty, propensity, by = c("naics" = "industry_code")) %>%
  mutate(fips = str_c(fipstate, fipscty, sep = "")) %>%
  select(-fipstate, -fipscty) 

all_employ <- employ_propensity %>%
  filter(naics == "all") %>%
  select(fips, emp) %>%
  rename("total_emp" = "emp")

employ_propensity_2 <- employ_propensity %>%
  filter(naics != "all") %>%
  left_join(all_employ, by = "fips") %>%
  mutate(affected_emp = emp * affected_share)

employ_propensity_3 <- employ_propensity_2 %>%
  group_by(fips) %>%
  mutate(affected_emp = replace_na(affected_emp, 0)) %>%
  summarize(affect_emp = sum(affected_emp), total_emp = total_emp) %>%
  distinct() %>%
  mutate(affected_share = affect_emp/total_emp)

# saved this as an RDS

# Now let's match this with DMAs

county_propensity <- readRDS('clean_data/employment_propensity.rds')

dma_codes <- read_csv('dma_codes.csv') %>%
  select(google_code, statefp, cntyfp) %>%
  mutate(statefp = str_pad(statefp, width = 2, side = "left", pad = "0"),
         cntyfp = str_pad(cntyfp, width = 3, side = "left", pad = 0)) %>%
  mutate(fips = str_c(statefp, cntyfp, sep = "")) %>%
  select(google_code, fips)

dma_propensity <- left_join(county_propensity, dma_codes, by = "fips") %>%
  drop_na(google_code) %>%
  select(-fips) %>%
  group_by(google_code) %>%
  select(-affected_share) %>%
  summarize(affect_emp = sum(affect_emp),
            total_emp = sum(total_emp)) %>%
  mutate(affected_share = affect_emp/total_emp)
  


```
```{r}
# let's do liquor stores


```

```{r}
# Try this again with just hospitality

employ_dirty <- read_csv('data/county_stats/cbp2019.csv', show_col_types = FALSE) %>%
  mutate(fipstate = as.character(fipstate),
         fipscty = as.character(fipscty)) %>%
  mutate(fipstate = str_pad(fipstate, width = 2, side = "left", pad = "0"),
         fipscty = str_pad(fipscty, width = 3, side = "left", pad = "0")) %>%
  
  # cleaning up the naics codes
  mutate(naics = gsub('------', 'all', naics)) %>%
  mutate(naics = gsub('/', '', naics)) %>%
  mutate(naics = gsub('-', '', naics)) %>%
  select(fipstate, fipscty, naics, emp) %>%
  filter(naics == "all" | naics == "72")

all_emp <- employ_dirty %>%
  filter(naics == "all") %>%
  select(fipstate, fipscty, emp) %>%
  rename("all_emp" = "emp")

hospitality_emp <- employ_dirty %>%
  filter(naics == "72") %>%
  select(-naics) %>%
  left_join(all_emp, by = c("fipstate", "fipscty")) %>%
  mutate(fips = str_c(fipstate, fipscty, sep = "")) %>%
  select(-fipstate, -fipscty)

# rerun the dma codes bit in the previous cell

dma_hospitality <- left_join(hospitality_emp, dma_codes, by = "fips") %>%
  drop_na(google_code) %>%
  select(-fips) %>%
  group_by(google_code) %>%
  summarize(emp = sum(emp),
            all_emp = sum(all_emp)) %>%
  mutate(affected_share = emp/all_emp)
```


```{r}
# Vaccinations
vaccinations_dirty <- read_csv('data/vaccinations.csv', show_col_types = FALSE) %>%
  clean_names() %>%
  select(date, fips, series_complete_pop_pct, series_complete_yes,
         administered_dose1_recip, administered_dose1_pop_pct)

# Let's match this by week!

week_begin <- readRDS('week_begin.rds')
```


```{r}
# politics

dma_codes <- read_csv('dma_codes.csv') %>%
  select(google_code, statefp, cntyfp) %>%
  mutate(statefp = str_pad(statefp, width = 2, side = "left", pad = "0"),
         cntyfp = str_pad(cntyfp, width = 3, side = "left", pad = 0)) %>%
  mutate(fips = str_c(statefp, cntyfp, sep = "")) %>%
  select(google_code, fips)

elections <- read_csv('data/county_stats/countypres_2000-2020.csv',
                      show_col_types = FALSE) %>%
  filter(year == 2020, party == "REPUBLICAN") %>%
  select(county_fips, candidatevotes, totalvotes) %>%
  mutate(county_fips = str_pad(county_fips, width = 5, side = "left", pad = "0")) %>%
  left_join(., dma_codes, by = c("county_fips" = "fips")) %>%
  drop_na(google_code) %>%
  select(google_code, candidatevotes, totalvotes) %>%
  group_by(google_code) %>%
  summarize(candidatevotes = sum(candidatevotes),
            totalvotes = sum(totalvotes)) %>% 
  mutate(gop_pct = candidatevotes/totalvotes * 100) %>%
  select(google_code, gop_pct)
  



  
```

